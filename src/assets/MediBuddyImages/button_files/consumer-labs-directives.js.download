!function(){"use strict";define(["_routes","utility","angular","angular","_routes","googleMaps"],function(e,t,a){e.register.directive("additionalTests",["$rootScope","navConstantsSvc","authService","corpLabsService","$state","apiProvider","$httpParamSerializer","$stateParams","$timeout","notify","$location","$uibModal","$interval",function(e,t,a,i,n,r,o,s,c,l,d,p,u){return{restrict:"AE",scope:{pipeline:"=?",patientId:"=?"},terminal:!0,priority:1e6,templateUrl:"labtest/templates/additionalTests.html?"+timeStamp,link:function(t,a,r){function o(){t.isMobileView=e.isMobileView,t.pipeline||(t.pipeline={}),t.pipeline.overrideTests=!0,t.packagePipeline={}}function s(){c.cancel(p),p&&(p.destroy(),p=null,u=null)}function l(e,a,i){var r=t.mergeList?_.union(t.mergeList.tests,t.mergeList.packages):[],o=n.includes("app.consumercorplabs");_.isEmpty(e)&&(e=r),_.each(t.packages,function(n){var s=e.find(function(e){return e.packageId==n.packageId});s?(n.selected="+"==a,n.cartId=s.cartId,n.showCount=!o&&t.pipeline.showBenefPopup?r.filter(function(e){return e.packageId==n.packageId}).length:0):i&&(n.selected=!1,n.cartId=0,n.showCount=0)})}window.updateSrc=!0;var d;o(),t.showTestDetails=function(e){t.packagePipeline.show=!0,t.packagePipeline.packageId=e};var p=null,u=null;t.initializeGlider=function(){c(function(){var e="suggested-tests-glider";u=document.querySelector("#"+e),u&&(p=new Glider(u,{slidesToShow:t.isMobileView?2.2:5.7,slidesToScroll:t.isMobileView?3:4.3,draggable:!1,scrollLock:!0,skipTrack:!0,duration:1.5,arrows:!t.isMobileView&&{prev:".prev-"+e,next:".next-"+e}}))},10)},t.initializeGlider();var g=e.$on("cartItemsUpdated",function(e,a){t.mergeList=i.labsCart(),t.pipeline.showBenefPopup=t.mergeList.patients.length>1,l(a.cartItems,a.op,a.refresh),t.pipeline.overrideTests&&(t.packages=a.additionalTests||[],t.pipeline.overrideTests=!1,_.isEmpty(t.packages)||i.sendEvents("Labs_suggestion_carousel_opened"),c(function(){p&&p.refresh()},500))}),m=e.$on("userLocation",function(e,a){t.pipeline.overrideTests=!0});t.$on("$destroy",function(e){s(),g(),m(),c.cancel(d)})}}}]),e.register.directive("ahcUpsell",["$rootScope","navConstantsSvc","standardEventsSvc","authService","corpLabsService","$state","apiProvider","$httpParamSerializer","$stateParams","$timeout","notify","$location","$uibModal","$interval",function(e,t,a,i,n,r,o,s,c,l,d,p,u,g){return{restrict:"AE",scope:{upSellObj:"=?",upsellCart:"=?",essFunc:"=?"},terminal:!0,priority:1e6,templateUrl:"labtest/templates/ahcUpsell.html?"+timeStamp,link:function(r,s,c){function p(e,t){_.isEmpty(e)||(r.upsellCart.updated||(r.upsellCart.updated=!0),"+"==t?r.upsellCart.items.push({packageId:e.packageId,patientId:e.patientId}):r.upsellCart.items=r.upsellCart.items.filter(function(t){return t.packageId!=e.packageId&&t.patientId!=e.patientId}),r.upsellCart.recentPatientId=e.patientId)}function u(e,t){if(!_.isEmpty(r.famPipeline[e])){var a=[];_.each(t,function(t){r.famPipeline[e].forEach(function(e){var i=JSON.parse(JSON.stringify(e));i.patientId=t.maid,i.relation=t.relation,i.source="upsell",a.push(i),p({packageId:e.packageId,patientId:t.maid},"+")})});var i=r.mergeList.isLabVisit?{providerId:_.first(r.upSellObj.providerIds)}:{};n.addItemsToCart(a,"+",!1,!0,{},i),r.famPipeline[e]=[]}}function g(){r.mergeList=n.labsCart(),r.packagePipeline={show:!1,providerId:0},r.beneficiaries=[],r.selectedBenef={maid:0,relation:"",groupedPackages:[],packages:[],currentCnt:3,maxCnt:3},r.famPipeline={show:!1,selectedItems:[],pendingItems:[],transit:!1,refreshCart:!1},r.familyPopupConfig={hideBenefs:!0,src:"ahcUpsell",defaultRelation:""},r.fetchUpsellPackages()}function m(){var e=_.isEmpty(r.mergeList)?[]:_.union(r.mergeList.tests,r.mergeList.packages);return{upsellFrom:r.upSellObj.src,upsellType:_.isEmpty(r.beneficiaries)?"":_.uniq(_.flatten(r.beneficiaries.map(function(e){return e.contracts}))).join(),cartItems:e.length,dependentCountSelected:_.uniq(_.pluck(e,"patientId")).filter(function(e){return e}).length}}function f(e,t,a){var i=r.mergeList?_.union(r.mergeList.tests,r.mergeList.packages):[];_.isEmpty(e)&&(e=i),_.isEmpty(r.selectedBenef.groupedPackages)||_.each(r.selectedBenef.groupedPackages,function(i){_.each(i,function(i){var n=e.find(function(e){return e.packageId==i.packageId&&e.patientId==r.selectedBenef.maid});n?(i.selected="+"==t,i.cartId=n.cartId,i.showCount=0):a&&(i.selected=!1,i.cartId=0,i.showCount=0,i.hideItem=!1)})}),_.isEmpty(r.selectedBenef.packages)||_.each(r.selectedBenef.packages,function(i){var n=e.find(function(e){return e.packageId==i.packageId&&e.patientId==r.selectedBenef.maid});n?(i.selected="+"==t,i.cartId=n.cartId,i.showCount=0):a&&(i.selected=!1,i.cartId=0,i.showCount=0,i.hideItem=!1)})}function v(){_.each(k,function(e,t){l.cancel(e),e&&(e.destroy(),k[t]=null,I[t]=null)})}r.isLoading=!0,r.upSellObj||(r.upSellObj={}),r.upsellCart&&r.upsellCart.items||(r.upsellCart={updated:!1,items:[]}),r.essFunc||(r.essFunc={}),r.isMobileView=e.isMobileView,window.updateSrc=!0;var h=i.isUserSignedin();r.specialConfig=h&&h.userDetails&&11187361==h.userDetails.pmEntityID,r.hideAddingBeneficiary=!h||h.userDetails&&t.hideAddBenfeciary.includes(h.userDetails.pmEntityID);var b=null;r.bannerUrl=h&&h.userDetails&&1048862!=h.userDetails.pmEntityID?r.isMobileView?"https://views.medibuddy.in/labs/assets/mobile/ahcUpsell.png":"https://views.medibuddy.in/labs/assets/web/ahcUpsell.png":"",r.onClickOfUpsellBanner=function(e){window.open("https://www.medibuddy.in/consumerLabs")},r.fetchUpsellPackages=function(){r.isLoading=!0,i.makeAjaxCalls(o.apiUrl+"/labs/v1/FetchUpsellPackages",{providerIds:r.upSellObj.providerIds,isLabVisit:r.mergeList.isLabVisit},"POST",h.token,i.getCity()).then(function(e){if(_.isEmpty(e.data.labsUpsellDetails)||_.isEmpty(e.data.labsUpsellDetails.benefDetails)||!e.data.labsUpsellDetails.benefDetails.some(function(e){return!_.isEmpty(e.benefRelationPackageIds)}))r.errorScreen=!0,n.sendEvents("No Upsell Packages Found",m());else{r.beneficiaries=[];var t=e.data.labsUpsellDetails;_.each(t.packages,function(e){e.isHomeSampleAvailable||(e.priceRange=Math.round(1.3*e.priceRange))}),_.each(t.benefDetails,function(e){_.isEmpty(e.beneficiaries)&&e.defaultBeneficiary&&!_.isEmpty(e.benefRelationPackageIds)&&!_.isEmpty(t.packages)?r.beneficiaries.push({"default":!0,relationName:e.relation,relation:e.relation,icon:n.getGenderIcon(1,e.gender,35),selected:!1,active:!0,contracts:_.uniq(t.packages.map(function(e){return e.contractId})),maid:-1,name:e.relation,packages:t.packages.filter(function(t){return e.benefRelationPackageIds.includes(t.packageId)})}):_.isEmpty(e.beneficiaries)||_.each(e.beneficiaries,function(e){var a={};_.extend(a,e),a.icon=n.getGenderIcon(e.maid,e.gender,e.age),a.packages=_.isEmpty(e.packagesListing)?[]:e.packagesListing,_.isEmpty(t.packages)||(a.packages=a.packages.concat(t.packages.filter(function(t){return e.paidPackage.includes(t.packageId)}))),a.relation=a.relationName,a.contracts=_.uniq(t.packages.map(function(e){return e.contractId})),a.active=!_.isEmpty(a.packages),a.sponsored=!_.isEmpty(e.sponsPackage),r.beneficiaries.push(a)})});var a={};if(r.selectedBenef.maid||(a=_.first(r.beneficiaries.filter(function(e){return e.active}))),_.isEmpty(a))if(_.isEmpty(b))d({message:"No packages found for added patient",position:"center",duration:5e3});else if(a=r.beneficiaries.find(function(e){return e.maid==b.maid}),_.isEmpty(a))d({message:"No packages found for added patient",position:"center",duration:5e3});else if(!_.isEmpty(r.famPipeline.pendingItems)){var i=r.famPipeline.pendingItems.map(function(e){return e.packageId});if(!_.isEmpty(i)){var o=a.packages.map(function(e){return e.packageId});_.every(i,function(e){return o.includes(e)})?u("pendingItems",[{maid:a.maid,relation:a.relationName}]):d({message:"The selected patient is not eligible for the package, please select different one",position:"center",duration:5e3})}}_.isEmpty(a)&&r.selectedBenef.maid&&(a=r.beneficiaries.find(function(e){return e.maid==r.selectedBenef.maid})),r.errorScreen=_.isEmpty(a),_.isEmpty(a)||(l(function(){k.beneficon.scrollItem(r.beneficiaries.findIndex(function(e){return e.maid==a.maid}))},700),r.onClickOfBenef(a))}r.upSellObj.skip=r.errorScreen,r.isLoading=!1})["catch"](function(e){r.isLoading=!1,r.errorScreen=!0,r.upSellObj.skip=!0,n.sendEvents("Error In Loading Packages",m())})},r.onClickOfPackageCard=function(e){r.packagePipeline.show=!0,r.mergeList.isLabVisit&&(r.packagePipeline.providerId=_.first(r.upSellObj.providerIds)),r.packagePipeline.packageId=e},g(),r.onClickOfBenef=function(e){r.selectedBenef.maid=e.maid,r.selectedBenef.relation=e.relationName,r.selectedBenef.groupedPackages=[],r.selectedBenef.packages=[];var t=-1;_.each(e.packages,function(e,a){e.price||(e.price=e.estimatedPrice),e.display=!0,r.selectedBenef.packages.push(e),a%2==0&&(r.selectedBenef.groupedPackages.push([]),t++),r.selectedBenef.groupedPackages[t].push(e)}),r.selectedBenef.maxCnt=r.selectedBenef.packages.length,_.each(r.beneficiaries,function(t){t.selected=e.maid!=-1?t.maid==e.maid:e.relation==t.relation}),l(function(){r.essFunc.refreshGlider()}),f([],"+",!0)},r.viewMoreTests=function(){r.selectedBenef.currentCnt<r.selectedBenef.maxCnt?(_.each(r.selectedBenef.packages,function(e,t){t<r.selectedBenef.currentCnt||t>=r.selectedBenef.currentCnt+3||l(function(){r.selectedBenef.currentCnt+=1},t%3*30)}),l(function(){var e=document.getElementById("view-more-tests");e&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},100)):(l(function(){var e=document.getElementById("labTests-section");e&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},100),_.each(r.selectedBenef.packages,function(e,t){t<3||(r.selectedBenef.currentCnt-=1)}))},r.essFunc.upsellPageEvent=function(e){n.sendEvents("Upsell Page",m()),n.sendEventsV1(a.LABS_CHECKOUT_FAMILY_UPSELL_PAGE,e)},r.addBenef=function(e){n.sendEvents("Add Family Member Clicked",m()),r.famPipeline.show=!0,r.familyPopupConfig.defaultRelation=""},r.addItem=function(e,t,a,i){if(e.relation=r.selectedBenef.relation,n.sendEvents("Add To Cart Button Clicked",{CartSource:"upsell"},new Array(e)),i&&i.stopPropagation(),r.selectedBenef.maid==-1)return r.familyPopupConfig.defaultRelation=r.selectedBenef.relation,void(r.famPipeline={selectedItems:[],pendingItems:new Array(e)||[],show:!0});e.selected=!0,e.patientId=r.selectedBenef.maid,e.source="upsell",p({packageId:e.packageId,patientId:e.patientId},"+");var o=r.mergeList.isLabVisit?{providerId:_.first(r.upSellObj.providerIds)}:{};n.addItemsToCart(new Array(e),"+",!1,!!h,{cartVisitType:r.upSellObj.cartVisitType},o)},r.removeItem=function(e,t,a,i){n.sendEvents("Remove From Cart Button Clicked",{CartSource:"upsell"},new Array(e)),i&&i.stopPropagation(),e.selected=!1,e.patientId=r.selectedBenef.maid,e.relation=r.selectedBenef.relation,p({packageId:e.packageId,patientId:e.patientId},"-");var o=r.mergeList.isLabVisit?{providerId:_.first(r.upSellObj.providerIds)}:{};n.addItemsToCart(new Array(e),"-",!1,!!h,{cartVisitType:r.upSellObj.cartVisitType},o)};var k={},I={},y={};r.initializeGlider=function(e,t,a){y[e]=l(function(){I[e]=document.querySelector("#"+e),I[e]&&(k[e]=new Glider(I[e],{slidesToShow:r.isMobileView?t[0]:t[1],slidesToScroll:a||1,draggable:!1,scrollLock:!0,skipTrack:!0,duration:1.5,arrows:!r.isMobileView&&{prev:".prev-"+e,next:".next-"+e}}))},10)},r.essFunc.refreshGlider=function(){_.each(k,function(e){e&&e.refresh&&e.refresh()})};var S=e.$on("cartItemsUpdated",function(e,t){r.mergeList=n.labsCart(),f(t.cartItems,t.op,t.refresh)}),C=r.$on("addedBenefeciary",function(e,t){b=null,_.isEmpty(t)||_.isEmpty(t.employeeDetail)||(b=_.first(t.employeeDetail.beneficiaries.filter(function(e){return e.maid==t.vasBenefId}))),r.famPipeline.show=!1,r.fetchUpsellPackages()});r.$on("$destroy",function(e){v(),_.each(y,function(e){l.cancel(e)}),C(),S(),window.updateSrc=!1})}}}]),e.register.directive("cartFooter",["$rootScope","navConstantsSvc","authService","corpLabsService","$state","apiProvider","$httpParamSerializer","$stateParams","$timeout","notify","$location","$uibModal","$interval",function(e,t,a,i,n,r,o,s,c,l,d,p,u){return{restrict:"AE",scope:{cartPipeline:"=?"},terminal:!0,priority:1e6,templateUrl:"labtest/templates/cartFooter.html?"+timeStamp,link:function(t,a,r){window.updateSrc=!0,t.isMobileView=e.isMobileView,t.cartPipeline||(t.cartPipeline={}),t.dialog=i.dialog,t.hideCartFooter=!1,t.goToCart=function(t){t&&i.sendEvents("Go To Cart Button Clicked"),n.go("app.consumerCart"),e.$broadcast("cartButtonClicked",!0)}}}}]),e.register.directive("comparePackages",["$rootScope","authService","apiProvider","$uibModal","$timeout","patternService","$state","corpLabsService","navConstantsSvc","$http","notify","$sce",function(e,t,a,i,n,r,o,s,c,l,d,p){return{restrict:"EA",scope:{pipeline:"=?"},templateUrl:"labtest/templates/comparePackages.html?"+timeStamp,link:function(a){function n(){a.loading.comparePacakge=!0,a.error.comparePacakge=!1;var e=s.getPackageDetail(a.comparePackages.map(function(e){return e.packageId}),0,0,!0);e.then(function(e){var t=_.values(e.descriptionMap);a.packagesData=Array(3).fill(0);for(var i=0;i<t.length;i++)a.packagesData[i]=t[i];a.packageCompareDetail=_.values(e.packageCompareDetail);var n=e.packageCompareText;a.packageCompareText=n?p.trustAsHtml(n.split("\n").join("<br/>")):null,u([],"+",!0),a.loading.comparePacakge=!1})["catch"](function(e){a.loading.comparePacakge=!1,a.error.comparePacakge=!0})}function l(){var e={};if(e.category="Default",e.loadSubCategories=!0,e.contractIds=[c.healthCheckContract],e.ignoreLoader=!0,0==a.comparePackagesList.length){a.loading.packageListing=!0,a.error.packageListing=!1;var t=s.fetchPackagesListing(e);t.then(function(e){g=e.packages,_.each(g,function(e){e.isCompared=!1}),a.comparePackagesList=g,_.each(a.comparePackagesList,function(e){const t=_.find(a.comparePackages,function(t){return t.packageId==e.packageId});e.isCompared=!!t}),a.loading.packageListing=!1})["catch"](function(e){a.loading.packageListing=!1,a.error.packageListing=!0})}else _.each(a.comparePackagesList,function(e){const t=_.find(a.comparePackages,function(t){return t.packageId==e.packageId});e.isCompared=!!t})}function u(e,t,i){var n=a.mergeList?_.union(a.mergeList.tests,a.mergeList.packages):[];_.isEmpty(e)&&(e=n),_.each(a.packagesData,function(r){if(r.packageId){var o=e.find(function(e){return e.packageId==r.packageId});o?(r.selected="+"==t,r.cartId=o.cartId,r.showCount=a.pipeline.showBenefPopup?n.filter(function(e){return e.packageId==r.packageId}).length:0):i&&(r.selected=!1,r.cartId=0,r.showCount=0)}})}a.user=t.isUserSignedin(),a.isMobileView=e.isMobileView,a.isFeatureEnabled=!0,a.patternCheck=r,a.isIOS=/iphone|ipod|ipad/.test(window.navigator.userAgent.toLowerCase()),a.showBottom=s.dialog.comparePackages,a.currentState=o.current.name,s.dialog.comparePackages=a.showBottom,a.loading={packageListing:!1,comparePacakge:!1},a.error={packageListing:!1,comparePacakge:!1},a.showShimmer={packageListing:Array(8).fill({})},a.comparePackages=s.comparePackages,a.basicdetails=!1,a.comparision=!1,a.summary=!1,a.comparePackagesList=[],a.mergeList=s.labsCart(),a.searchVars={searchText:"",suggestedKeyword:"",cartText:"Go To Cart",searchResults:[]},a.searchVars.placeholder="Search for Health Checkup Packages",a.toggleCompareBar=function(){a.showBottom=!a.showBottom,a.showBottom&&s.sendEvents("CompareFeatureClicked"),s.dialog.comparePackages=a.showBottom},a.clearText=function(){a.searchVars.searchText="",a.searchVars.suggestedKeyword=""},a.addToCartEvent=function(e){s.sendEvents("AddToCartComparePackages",{packageId:e.packageId,packageName:e.packageDisplayName})},a.addorremovepackage=function(t,i,n){if(a.comparePackages.length>=3&&"add"==t)return void d({message:"You can add only 3 packages!!",position:"center",duration:3e3});if("remove"==t){_.each(a.comparePackagesList,function(e){const t=e.packageId==i.packageId;t&&(e.isCompared=!t)});for(var r=0;r<a.comparePackages.length;r++)a.comparePackages[r].packageId==i.packageId&&(n=r);e.$emit("removedFromCompare",i.packageId)}else"clear"==t&&e.$emit("clearCompare");"add"==t&&a.comparePackages.length<3&&(_.each(a.comparePackagesList,function(e){const t=e.packageId==i.packageId;t&&(e.isCompared=!!t)}),e.$emit("addedToCompare",i.packageId)),s.addOrRemoveComparePages(i,t,n)},a.removePackage=function(e,t,i){a.packagesData[i]=0,i=a.comparePackages.indexOf(t),a.addorremovepackage(e,t,i)},a.scrollToView=function(e){e||!document.getElementById("hc-section")||"app.consumerLabs"!=a.currentState&&"app.radiologyTests"!=a.currentState||document.getElementById("hc-section").scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},a.openPackagesPopUp=function(t,r){t&&t.stopPropagation(),a.popUpState=r,a.packagesData=Array(3).fill(0),i.open({animation:!0,scope:a,backdrop:"none",template:'<div ng-class="{\'modal-bottom-header modal-header\': isMobileView, \'modal-body clearfix\': !isMobileView}"><div class="clearfix text-right"><span class="cursor-pointer" ng-style="{\'color\': isHover ? \'#000\' : \'#aaa\'}" ng-class="{\'md-dark-color\': isMobileView}" ng-init="isHover=false;" ng-mouseover="isHover=true;" ng-mouseout="isHover=false;" ng-click="cancelDialog($event)">close</span></div><ng-include src="\'packages_popup.html\'"></ng-include></div>',controller:["$scope","$uibModalInstance",function(e,t){e.cancelDialog=function(){t.dismiss("cancel")}}],size:e.isMobileView?"bottom":"lg modal-border",windowClass:e.isMobileView&&"bottom-sheet"}),1==r?(s.sendEvents("BottomCompareNowCTA"),n()):2==r&&(s.sendEvents("BottomAddPackagesCTA"),l())},a.popUpStatehandler=function(e,t){a.popUpState=e,t&&s.sendEvents(t),1==a.popUpState&&n(),2==a.popUpState&&l()};var g,m=e.$on("cartItemsUpdated",function(e,t){a.mergeList=s.labsCart(),a.pipeline.showBenefPopup=a.mergeList.patients.length>1,u(t.cartItems,t.op,t.refresh)}),f=e.$on("cartButtonClicked",function(e,t){a.showBottom=!1,s.dialog.comparePackages=a.showBottom}),v=e.$on("userLocation",function(e,t){a.pincode=t.pincode}),h=document.getElementById("bottom-bar");h.addEventListener("click",function(e){e.offsetY<0&&a.toggleCompareBar()}),a.$on("$destroy",function(){m(),f(),v()})}}}]),e.register.directive("corporateBenefits",["$rootScope","navConstantsSvc","authService","corpLabsService","$state","apiProvider","$httpParamSerializer","$stateParams","$timeout","notify","$location","$uibModal","$interval","$http",function(e,t,a,i,n,r,o,s,c,l,d,p,u,g){return{restrict:"AE",scope:{obj:"=?",pipeline:"=?",blockDetails:"@"},terminal:!0,priority:1e6,templateUrl:"labtest/templates/corporateBenefits.html?"+timeStamp,link:function(o,s,l){function g(e){o.data=e,o.walletstring=e.walletServiceList?e.walletServiceList.join(" | "):"",o.loaded=!0,o.corpBenefits=e;var a=o.banners.find(function(e){return"labs_ahc_sponsored"==e.bannedId});a&&(a.isActive=![11186914].includes(o.user.userDetails.pmEntityID)&&(e.isSponsoredPackagesAvailable||e.isPaidPackagesAvailable),11187059==o.user.userDetails.pmEntityID&&(a.bannerurl="/assets/banners/ahc_sponsored_mb_premio.webp"));var i=o.banners.find(function(e){return"diagnostic-banner"==e.bannedId});i&&(i.isActive=!t.providerFlowDisabledEntites.includes(o.user.userDetails.pmEntityID))}function m(){a.makeAjaxCalls(r.apiUrl+"/pageConfiguration?pageId=labs_home_page","","GET",o.user?o.user.token:"").then(function(e){if(e.data&&e.data.widgets&&!_.isEmpty(e.data.widgets)){var t=e.data.widgets.find(function(e){return"labs_home_banner_carousel"==e.widgetId});t&&(o.banners=t.subWidgets.filter(function(e){return!_.isEmpty(e.properties)}).map(function(e){return{bannerurl:e.properties.contentUrl,bannerId:e.widgetId,height:140,order:e.position||1,alt:e.widgetId,property:e.properties}})),o.initializeGlider()}})["catch"](function(e){console.error("Failed to fetch widgets:",e)})}function f(){o.loaded=!1,a.makeAjaxCalls(r.apiUrl+"/Labs/v1/FetchCorporateBenefits",{fetchWalletServices:!1},"POST",o.user.token,a.getCity(),!0).then(function(e){e.data.isSuccess?(e.data.showDiscountedBanner&&(b+=1),e.data.showCorporateWalletBanner&&(b+=1),e.data.showCorporateBenefitsBanner&&(b+=1),i.corpBenfits=e.data,g(e.data)):o.hide=!0,o.$emit("corporateBenefits",e.data),o.loaded=!0})["catch"](function(e){o.hide=!0,o.loaded=!0})}function v(){o.banners=[],o.user&&!o.user.isRetailUser?_.isEmpty(i.corpBenfits)?f():g(i.corpBenfits):o.user&&o.user.isRetailUser?g({}):o.loaded=!0,m()}function h(){var e=o.banners.filter(function(e){return e.isActive}).length;if(k){var t=(k.slide+1)%(o.isMobileView?e:e-2);k.scrollItem(t)}else u.cancel(y)}o.user=a.isUserSignedin(),o.isMobileView=e.isMobileView,o.isRetailUser=o.user.isRetailUser||!o.user,o.loaded=!1,o.hide=!1,o.landingPage=n.includes("app.home");var b=0;o.landingPage||(b+=1);var k=null,I=null,y=null;o.redirectToCorpote=function(){i.sendEvents("Corporate Benefits Banner Clicked"),d.url("/consumercorporatelabs")},o.redirectToSurgery=function(){i.sendEvents("Labs_Surgery_Banner_Clicked"),window.open("https://form.typeform.com/to/I79s2Diu","_blank")};var S=!1;o.initializeGlider=function(){S||c(function(){I=document.querySelector("#corporate-benefits"),I&&I.addEventListener("glider-animated",function(e){y&&(u.cancel(y),y=null),y=u(h,4e3)}),I&&(k=new Glider(I,{slidesToShow:o.isMobileView?1:3,slidesToScroll:1,draggable:!1,scrollLock:!0,skipTrack:!0,duration:4,dots:"#dots-corporate-benefits"}),S=!0),o.banners.length>1&&(y=u(h,4e3))},10),c(function(){k&&k.refresh()},10)},o.fetchBeneficiaries=function(){a.makeAjaxCalls(r.apiUrl+"/Labs/v2/FetchBenefeciary.json","","GET",o.user.token).then(function(e){e.data.isSuccess&&!_.isEmpty(e.data.employeeDetail)&&(o.benefeciaries=e.data.employeeDetail.beneficiaries,o.allowedRelations=e.data.employeeDetail.allowedRelations,_.each(o.benefeciaries,function(e){e.icon=i.getGenderIcon(e.maid,e.gender,e.age)}))})},v(),o.onCLickOfBanner=function(e){if(e&&e.property&&e.property.onClick&&e.property.onClick.type){var t=e.property.onClick;switch(_.isEmpty(t.eventPayload)||i.sendEvents(t.eventPayload.name,t.eventPayload),t.type){case"deeplink":window.location.href=t.value;break;case"redirection":window.open(t.value,"_blank")}}},o.addBeneficiaries=function(){o.fetchBeneficiaries(),p.open({animation:!0,size:e.isMobileView?"login-new modal-bottom":"login-new",scope:o,backdrop:"none",templateUrl:"beneficiaries.html",controller:["$scope","$uibModalInstance",function(e,t){e.closeModal=function(){t.dismiss("cancel")}}],size:o.isMobileView?"bottom":"border modal-sm",windowClass:e.isMobileView&&"bottom-sheet"})};var C=e.$on("userLogout",function(e,t){o.$emit("corporateBenefits",{}),o.hide=!0,i.corpBenfits={},o.isRetailUser=!0,o.user=null,m()}),P=e.$on("userLogin",function(e,t){o.$emit("corporateBenefits",{}),o.hide=!1,o.loaded=!1,i.corpBenfits={},o.user=a.isUserSignedin(),o.isRetailUser=o.user.isRetailUser||!o.user,v()});o.$on("$destroy",function(e){C(),P(),y&&(u.cancel(y),y=null)})}}}]),e.register.directive("familyPopUp",["notify","$rootScope","authService","apiProvider","$uibModal","$timeout","patternService","$state","corpLabsService","navConstantsSvc","standardEventsSvc",function(e,t,a,i,n,r,o,s,c,l,d){return{restrict:"EA",scope:{pipeline:"=",benefeciaries:"=?",fetchPackages:"=?",showAddMember:"@",mergeList:"=?",config:"=?"},templateUrl:"labtest/templates/familyPopUp.html?"+timeStamp,link:function(p){function u(){p.loading.benefs=!0;var e="/Labs/v2/FetchBenefeciary";a.makeAjaxCalls(i.apiUrl+e,"","GET",p.user.token,"",!0).then(function(e){if(p.loading.benefs=!1,e.data.isSuccess){if(p.benefeciaries=e.data.employeeDetail.beneficiaries,p.isFamilyFlowEnabled=e.data.employeeDetail.isFamilyFlowEnabled,p.isFamilyFlowEnabled&&(p.isBenefAdditionAllowed=e.data.employeeDetail.isBenefAdditionAllowed,p.allowedRelations=e.data.employeeDetail.allowedRelations,p.compulsoryField=e.data.employeeDetail.compulsoryField,p.allowedRelationsIds=[],p.benefList=[],_.each(p.allowedRelations,function(e){p.benefList.push({isSelected:!1,isDisabled:!1,isActive:!0,gender:e.gender?"M"==e.gender||"Male"==e.gender?"M":"F"==e.gender||"Female"==e.gender?"F":"":"",relationName:e.relation,relationId:e.relationId}),p.allowedRelationsIds.push(e.relationId)})),_.each(p.benefeciaries,function(e){e.display=!1}),0==p.benefeciaries.length)return p.showAddMember=!0,void r(function(){k.refresh(!0)});h(),r(function(){k.refresh(!0)})}else p.showAddMember=!0,r(function(){k.refresh(!0)})})["catch"](function(e){p.loading.benefs=!1})}function g(){p.isMobileView?u():r(function(){var e=document.getElementById("familysideBar"),t=document.getElementById("backDrop"),a=document.getElementById("bottomCta");e&&(e.classList.toggle("open"),a&&a.classList.toggle("open"),t&&t.classList.toggle("open"),u())},300),c.remLabsStickyHeader(),c.dialog.familyPopup=!0}function m(){var e=document.getElementById("familysideBar"),t=document.getElementById("backDrop"),a=document.getElementById("bottomCta");c.dialog.familyPopup=!1,e&&e.classList.toggle("open"),t&&t.classList.toggle("open"),a&&a.classList.toggle("open"),r(function(){p.pipeline.show=!1,p.pipeline["package"]="",p.pipeline.searchPackages="",p.pipeline.packageEligiblitiy=[]},450)}function f(){p.dependentInfo={gender:"M",relation:"",submitted:!1,name:"",age:"",dob:"",mobileNumber:"",aliasRelation:""},p.dob="";var e=document.getElementById("custom-date");e&&(e.addEventListener("focus",function(){p.isDobFocused=!0,p.$apply()}),e.addEventListener("focusout",function(){p.isDobFocused=!1,p.$apply()}),e.addEventListener("keypress",setTimeout(function(){onkeyenter(event)},100)))}function v(e){_.isEmpty(e)&&(e=_.isEmpty(p.mergeList)?[]:_.union(p.mergeList.tests,p.mergeList.packages));var t="labTest";return e.find(function(e){return e.contractId==l.ahcContract})?t="AHC":e.find(function(e){return e.contractId==l.healthCheckContract})&&(t="healthCheck"),{packageName:_.pluck(e,"packageDisplayName").toString(),packageId:_.pluck(e,"packageId").toString(),visitType:e.find(function(e){return!e.isHomeSampleAvailable})?"centerVisit":"homeVisit",isSponsored:!!e.find(function(e){return e.isSponsored}),ahcTestCount:e.filter(function(e){return e.contractId==l.ahcContract}).length,labTestCount:e.filter(function(e){return e.contractId==l.labtestContract}).length,healthCheckCount:e.filter(function(e){return e.contractId==l.healthCheckContract}).length,serviceName:t}}function h(e,t){const a=[1,2,5,17];p.isFamilyFlowEnabled||(p.benefeciaries=_.sortBy(p.benefeciaries,"maid").reverse());var i;p.benefeciaries=_.each(p.benefeciaries,function(n,o){if(n.isDisabled=!1,n.isSelected=!1,n.icon=c.getGenderIcon(n.maid,n.gender,n.age),n.isEligible=!!p.user.isRetailUser||!(p.pipeline["package"]&&p.pipeline["package"].contractId==l.ahcContract&&!_.isNaN(p.pipeline.packageEligiblitiy))||p.pipeline.packageEligiblitiy.findIndex(function(e){return n.maid==e})>-1,!_.isEmpty(p.pipeline.mergeList)&&p.pipeline["package"]&&(d=p.pipeline.mergeList.selectedList[n.maid]?p.pipeline.mergeList.selectedList[n.maid].findIndex(function(e){return e.packageId==p.pipeline["package"].packageId}):-1,n.isDisabled="-"==p.pipeline.op?d==-1:d>-1,n.isSelected=d>-1),a.includes(n.relationId)&&!p.isFamilyFlowEnabled){const d=p.benefList.findIndex(function(e){return e.relationId==n.relationId});d>-1&&(p.benefList[d].isDisabled=!0,p.benefList[d].isActive=!1)}if("app.consumerCart"===s.current.name&&_.isEmpty(p.pipeline.selectedItems)&&p.pipeline.mergeList&&p.pipeline.mergeList.selectedList){var d=_.keys(p.pipeline.mergeList.selectedList).findIndex(function(e){return e==n.maid});d>-1&&(n.isSelected=!0,n.isDisabled=!0)}if(!_.isEmpty(e)&&e.vasBenefId&&n.maid==e.vasBenefId&&(n.isSelected=!0),t&&n.maid==t&&(i=n),p.pipeline["package"]&&!_.isEmpty(e)&&!_.isEmpty(e.packages)&&n.maid==e.vasBenefId){var d=e.packages.findIndex(function(e){return p.pipeline["package"].packageId==e.packageId});d==-1&&(p.packageNotEligible=!0,n.isEligible=!1,n.isDisabled=!0,n.isSelected=!1)}r(function(){n.display=!0},60*o)}),p.packageNotEligible&&r(function(){p.packageNotEligible=!1},5e3),i&&p.onBenefSelect(i)}p.user=a.isUserSignedin(),p.isMobileView=t.isMobileView,p.patternCheck=o,p.disableGender=!1,p.isCartPage=s.includes("app.consumerCart");var b=s.includes("app.payment");p.loading={benefs:!1},p.hideAddingBeneficiary=!p.user||p.user&&p.user.userDetails&&l.hideAddBenfeciary.includes(p.user.userDetails.pmEntityID),p.pipeline||(p.pipeline={}),p.config||(p.config={}),p.benefList=[{isSelected:!1,isDisabled:!1,isActive:!0,gender:"",relationName:"Self",relationId:1},{isSelected:!1,isDisabled:!1,isActive:!0,gender:"M",relationName:"Father",relationId:5},{isSelected:!1,isDisabled:!1,isActive:!0,gender:"F",relationName:"Mother",relationId:2},{isSelected:!1,isDisabled:!1,isActive:!0,gender:"M",relationName:"Brother",relationId:3},{isSelected:!1,isDisabled:!1,isActive:!0,gender:"F",relationName:"Sister",relationId:7},{isSelected:!1,isDisabled:!1,isActive:!0,gender:"F",relationName:"Daughter",relationId:4},{isSelected:!1,isDisabled:!1,isActive:!0,gender:"M",relationName:"Son",relationId:8},{isSelected:!1,isDisabled:!1,isActive:!0,gender:"",relationName:"Spouse",relationId:17},{isSelected:!1,isDisabled:!1,isActive:!0,gender:"",relationName:"Others",relationId:23}],p.isFamilyFlowEnabled=!1,p.isBenefAdditionAllowed=!0,p.isFamilyFlowEnabled&&(p.benefList=[]),p.compulsoryField={relation:!0,name:!0,phonenumber:!1,dob:!0,gender:!0},p.aliasRelation=!1,p.stepper=1;var k=null,I=null;if(p.initializeGlider=function(e){var t=e;r(function(){I=document.querySelector("#"+t),I&&(k=new Glider(I,{slidesToShow:2,slidesToScroll:2,draggable:!1,skipTrack:!0,scrollLock:!0,arrows:{prev:".prev-"+t,next:".next-"+t},dots:!1}))},0)},g(),p.pipeline&&!p.pipeline.mergeList&&(p.pipeline.mergeList=a.mergeCart),_.isEmpty(p.mergeList)||"app.consumerCart"!==s.current.name||(p.pipeline.mergeList=p.mergeList),p.dependentInfo={gender:"",relation:"",submitted:!1,mobileNumber:""},p.calenderDetails={isOpen:!1,dobOptions:{maxDate:new Date,minDate:new Date(1917,1,1)}},p.form={},p.packageNotEligible=!1,p.selectedBenef=function(e){_.each(p.benefList,function(e){e.isSelected=!1}),e.isSelected=!0,p.dependentInfo.relation=e.relationName,p.dependentInfo.relid=e.relationId,p.aliasRelation=!(23!=p.dependentInfo.relid||!p.isFamilyFlowEnabled),e.gender?(p.dependentInfo.gender=e.gender,p.disableGender=!0):(p.dependentInfo.gender="M",p.disableGender=!1),r(function(){k.refresh(!0)},0)},p.pipeline.searchPackages&&(p.pipeline.searchPackages=_.sortBy(p.pipeline.searchPackages,function(e){return e.packageDisplayName.length})),p.isDobFocused=!1,p.dob="",p.benefItemClcik=function(e){if(!e.isDisabled&&e.isEligible){e.isSelected=!e.isSelected,p.showErrorBorder=!1;var t=v();c.sendEvents("Add Family Member",_.extend({name:e.name,memberType:e.relationName,gender:e.gender,maid:e.maid},t))}},p.switchBoolean=function(e,t){p[e]=!p[e],"showAddMember"==e&&(p.showAddMember?(c.sendEventsV1(d.LABS_ADD_PATIENT_DETAILS,{}),p.isFamilyFlowEnabled&&c.sendEventsV1(d.FAMILY_FLOW_EVENTS,{subEventName:"FFW_ADD_FAMILY",screenName:b?"Meds Flow":"Labs Flow"}),c.sendEvents("Add New Family Member",v())):p.isFamilyFlowEnabled&&!_.isEmpty(t)&&"cancel"==t&&c.sendEventsV1(d.FAMILY_FLOW_EVENTS,{subEventName:"FFW_ADD_FAMILY_CANCEL",screenName:b?"Meds Flow":"Labs Flow"}),f(),p.showErrorBorder=!1,_.each(p.benefList,function(e){e.isSelected=!1}),r(function(){k.refresh(!0)},0))},p.validate=function(e,t){var a=new RegExp(p.patternCheck.getRegexExpression(t)),i=String.fromCharCode(e.charCode?e.charCode:e.which);if(!a.test(i)&&13!==e.charCode&&9!==e.charCode)return e.preventDefault(),!1},p.genderClick=function(e){p.disableGender||(p.dependentInfo.gender=e)},p.onBenefSelect=function(e,a){if(a&&a.stopPropagation(),e.isEligible&&!e.isDisabled){t.medsFamilyFlow&&_.forEach(p.benefeciaries,function(e){e.isDisabled||(e.isSelected=!1)}),e.isSelected=!e.isSelected,p.showErrorBorder=!1,(p.pipeline["package"]||p.pipeline.searchPackages)&&(p.benefCount=_.filter(p.benefeciaries,function(e){return e.isSelected&&!e.isDisabled}).length,p.price=p.pipeline&&p.pipeline["package"]?p.pipeline["package"].price:p.pipeline.searchPackages?_.pluck(p.pipeline.searchPackages,"price").reduce(function(e,t){
return e+t},0):0);var i=v();c.sendEvents("Add Family Member",_.extend({name:e.name,memberType:e.relationName,gender:e.gender,maid:e.maid},i))}},p.confirm=function(){var e=_.filter(p.benefeciaries,function(e){return e.isSelected&&!e.isDisabled});return e.length||"-"==p.pipeline.op?(c.sendEventsV1(d.LABS_PATIENT_DETAILS_SELECTED_DONE,{patientid:_.pluck(e,"maid").join(),patient_relation:_.pluck(e,"relationName").join(),patient_name:_.pluck(e,"name").join(),patient_age:_.pluck(e,"age").join()}),c.dialog.labsFixedHeader&&c.addLabsStickyHeader(),p.$emit("familyConfirmClicked",e,p.pipeline["package"]),c.sendEvents("Add Family Member Success",v()),t.medsFamilyFlow=!1,void m()):void(p.showErrorBorder=!0)},p.dobChanged=function(){const e=/(0[1-9]|[12][0-9]|3[01])\-(0[1-9]|1[012])\-(19\d\d|20\d\d)/g;return p.dependentInfo.dob.match(e)?void(p.dateError=!1):void(p.dateError=!0)},p.mobileChanged=function(){const e=/^[0-9]{10}$/;return!p.dependentInfo.mobileNumber.match(e)&&p.dependentInfo.mobileNumber?void(p.mobileError=!0):void(p.mobileError=!1)},p.addFamily=function(){if(p.dependentInfo.submitted=!0,p.form.patientForm.$valid&&p.dependentInfo.relation){const t=/(0[1-9]|[12][0-9]|3[01])\-(0[1-9]|1[012])\-(19\d\d|20\d\d)/g;if(!p.dependentInfo.dob.match(t))return void(p.dateError=!0);var n=p.dependentInfo.dob.split("-"),o=Number(n[0]),s=Number(n[1])-1,l=Number(n[2]);if(1==s&&(30==o||31==o))return void(p.dateError=!0);var u=new Date(l,s,o);if(u>new Date)return void(p.dateError=!0);const g=/^[6-9][0-9]{9}$/;if(p.compulsoryField.phonenumber&&!p.dependentInfo.mobileNumber.match(g))return void(p.mobileError=!0);p.isFamilyFlowEnabled&&c.sendEventsV1(d.FAMILY_FLOW_EVENTS,{subEventName:"FFW_ADD_FAMILY_SAVE",screenName:b?"Meds Flow":"Labs Flow",relationshipName:p.dependentInfo.relation||""});var k={relationName:p.dependentInfo.relation,name:p.dependentInfo.name,dob:u.toJSON(),mobileNumber:p.dependentInfo.mobileNumber,relationId:p.dependentInfo.relid,gender:p.dependentInfo.gender,fetchPackages:!!p.fetchPackages&&p.fetchPackages,fetchRetailPackages:!!p.fetchPackages&&p.fetchPackages,aliasRelation:p.dependentInfo.aliasRelation};a.makeAjaxCalls(i.apiUrl+"/Labs/v2/AddBenefeciary",k,"POST",p.user.token,!1).then(function(t){if(t.data.isSuccess){if(f(),p.switchBoolean("showAddMember"),p.benefeciaries=t.data.employeeDetail.beneficiaries,p.isFamilyFlowEnabled&&(p.allowedRelations=t.data.employeeDetail.allowedRelations,p.allowedRelationsIds=[],p.benefList=[],_.each(p.allowedRelations,function(e){p.benefList.push({isSelected:!1,isDisabled:!1,isActive:!0,gender:e.gender?"M"==e.gender||"Male"==e.gender?"M":"F"==e.gender||"Female"==e.gender?"F":"":"",relationName:e.relation,relationId:e.relationId}),p.allowedRelationsIds.push(e.relationId)})),t.data.vasBenefId){var i=p.benefeciaries.find(function(e){return e.maid==t.data.vasBenefId});i&&(i.benefType="New",c.sendEventsV1(d.LABS_ADD_NEW_PATIENT,{patient_relation:i.relationName,patient_name:i.name,patient_age:i.age.toString()})),r(function(){var e=document.getElementById("benef-"+t.data.vasBenefId);e&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})})}_.isEmpty(a.mergeCart)||(a.mergeCart.benefDetails||(a.mergeCart.benefDetails={}),a.mergeCart.benefDetails[t.data.vasBenefId]=p.benefeciaries.find(function(e){return e.maid==t.data.vasBenefId})),p.config.hideBenefs?(m(),p.$emit("addedBenefeciary",t.data)):t.data.packages?(p.pipeline["package"]&&_.pluck(t.data.packages,"packageId").includes(p.pipeline["package"].packageId)&&p.pipeline.packageEligiblitiy.push(t.data.vasBenefId),h(t.data),p.$emit("addedBenefeciary",t.data)):h(null,t.data.vasBenefId);var n=v();c.sendEvents("Add New Family Member Success",_.extend({name:k.name,memberType:k.relationName,gender:k.gender},n))}else e({message:t.data.errorMessage||"Some error occured.!",position:"center",duration:5e3})})}},p.config.hideBenefs&&(p.showAddMember=!0,r(function(){k.refresh(!0)}),p.config.defaultRelation)){var y=null;_.each(p.benefList,function(e){e.relationName==p.config.defaultRelation?y=e:e.isActive=!1}),!!y&&p.selectedBenef(y)}var S=null;p.isMobileView&&(S=n.open({animation:!0,scope:p,backdrop:"none",templateUrl:"labtest/templates/mobileFamilyPopUp.html?"+timeStamp,controller:["$scope","$uibModalInstance",function(e,t){}],size:t.isMobileView?"bottom":"border",windowClass:t.isMobileView&&"bottom-sheet"}).closed.then(function(){p.pipeline.show=!1,p.pipeline["package"]="",p.pipeline.searchPackages="",p.pipeline.packageEligiblitiy=[]})),p.backDrropClicked=function(){m(),p.$emit("onBackDropClicked")},p.$on("$destroy",function(){p.pipeline.show=!1,p.pipeline["package"]="",p.pipeline.searchPackages="",p.pipeline.packageEligiblitiy=[]})}}}]),e.register.directive("labsCalendar",["$rootScope","navConstantsSvc","authService","$state","apiProvider","$httpParamSerializer","$stateParams","$timeout","notify","$location","corpLabsService",function(e,t,i,n,r,o,s,c,l,d,p){return{restrict:"AE",scope:{obj:"=?",pipeline:"=?",blockDetails:"=?",reqParams:"=?",isFasting:"=?",prevSelected:"=?"},terminal:!0,priority:1e6,templateUrl:"templates/labsCalendar.html?"+timeStamp,link:function(n){function o(){n.pipeline||(n.pipeline={}),n.blockDetails||(n.blockDetails={}),n.pipeline.initDate&&(h=new Date(n.pipeline.initDate)),n.pipeline.slotIntervalMin&&(slotIntervalMin=n.pipeline.slotIntervalMin),n.pipeline.totalDays&&(v=n.pipeline.totalDays),n.dateArray=[],d()}function s(e){var t=e%60,a="",i=Math.floor(e/60);return i>=12?(a="PM",12===i?i=i:i-=12):a="AM",[i,t,a]}function l(e,t){return e=e.toString(),e.length<t?l("0"+e,t):e}function d(){n.isMedibuddyLoading=!0,n.showExtraGuidelines=!1,console.log(n.obj);var e={providerIds:_.flatten(n.obj.dcIds),noOfDays:"30",isMergeFlow:!0,isHomeVisitCase:!n.obj.isLabVisit,isBookingFlow:_.isEmpty(n.obj.reqIds),orderId:n.obj.orderId,requestIds:n.obj.reqIds};_.isEmpty(n.reqParams)||_.extend(e,n.reqParams),e.contractId||(e.contractId=10386),i.makeAjaxCalls(r.apiUrl+"Labs/ProvidersCalendar",e,"POST",b.token,k,!0).then(function(e){if(e.data.isSuccess){var t=_.first(e.data.providerSlots);if(!_.isEmpty(t))return n.obj.providerSlots=t.daySlots,void g(t.daySlots)}n.calendarCheck=!1,n.isMedibuddyLoading=!1})["catch"](function(e){n.calendarCheck=!1,n.isMedibuddyLoading=!1})}function u(){if(n.blockDetails.blockTillDate){var e=new Date(n.blockDetails.blockTillDate);_.each(n.dateArray,function(t){t.date<e&&(t.disabled=!0)})}if(!_.isEmpty(n.blockDetails.blockDates)){var t=n.blockDetails.blockDates.map(function(e){return new Date(e)});_.each(n.dateArray,function(e){t.Contains(e.date)&&(e.disabled=!0)})}}function g(e){n.dateArray=m(e),u();var t=-1;return _.isEmpty(n.prevSelected)||(t=n.dateArray.findIndex(function(e){return!e.disabled&&e.date==n.prevSelected.epochDate})),t<0&&(t=n.dateArray.findIndex(function(e){return!e.disabled})),t<0?(n.calendarCheck=!1,void(n.isMedibuddyLoading=!1)):(n.pickDate(n.dateArray[t],t),n.calendarCheck=!0,void(n.isMedibuddyLoading=!1))}function m(e){return e.map(function(e){var a={dateString:e.dateString,date:new Date(parseInt(e.date.replace("/Date(","").replace(")/",""))).setHours(0,0,0,0),formattedDate:e.dateString.split("-").slice(0,-1).join(" "),formattedDay:e.workingDaySlots.dayOfWeek,selected:!1,disabled:e.availableSlots<1};return a.disabled?a.overallSlotState={className:"not-available noavail not-available time-restricted",status:"Unavailiable"}:(e.availableSlots<=e.totalSlots*(t.minSlotThreshold/100)?a.overallSlotState={className:"almost-full active",status:"Filling fast",color:"#cc8800"}:a.overallSlotState={className:"slot-available active",status:"Available",color:"#81a200"},a.availableSlots=e.workingDaySlots),a})}function f(e){return a.forEach(e,function(t,a){if(t.slotStartTime||0===t.slotStartTime){var i=s(t.slotStartTime),n=l(i[0],"2")+":"+l(i[1],"2");e[a].startTime=n,e[a].startTimeMweb=i[1]?n:i[0],e[a].selected=!1,e[a].startTimeAmPm=i[2],e[a].time=n+" "+i[2],t.slotEndTime&&(i=s(t.slotEndTime),n=l(i[0],"2")+":"+l(i[1],"2"),e[a].endTime=n,e[a].endTimeMweb=i[1]?n:i[0],e[a].endTimeAmPm=i[2])}}),e}var v=30,h=new Date,b=i.isUserSignedin(),k=i.getCity(),I=-1;n.isMobileView=e.isMobileView,n.isFasting=n.isFasting&&n.obj.isLabVisit,Date.prototype.addDays=function(e){return this.setDate(this.getDate()+parseInt(e)),this},Date.prototype.nextDay=function(e){var t=new Date(this.valueOf());return t.setDate(t.getDate()+e),t},o();var y={};n.initializeGlider=function(e){c(function(){y[e]=new Glider(document.querySelector("#"+e),{slidesToShow:n.isMobileView?"cal-glider"==e?3.5:"auto":6,slidesToScroll:"auto",draggable:!0,arrows:"cal-glider"==e&&{prev:".prev-"+e,next:".next-"+e}}),"cal-glider"==e&&y["cal-glider"].scrollItem(I)})},n.pickDate=function(e,t){if(!e.disabled){n.showExtraGuidelines?(n.removeExtraGuidelines=!0,c(function(){n.removeExtraGuidelines=!1},700)):n.removeExtraGuidelines=!1,n.showExtraGuidelines="Saturday"==e.formattedDay;var a=e.availableSlots.slots.map(function(e){return _.pick(e,"slotStartTime","slotEndTime","servingProviders","slotCount","slotStartDateTime","slotDistributionForDate","slotDistributionForInterval","realtimePhlebo")}),i=null;_.isEmpty(n.prevSelected)||(i=a.find(function(e){return e.slotStartDateTime==n.prevSelected.dateTime})),i||(i=_.isEmpty(n.slots)?null:n.slots.find(function(e){return e.selected}));var r=f(a);if(_.isArray(r)){if(n.obj.prefDate=e.date,n.obj.dateTitle=e.dateString+", "+e.formattedDay,n.slots=r,i){var o=r.find(function(e){return e.slotStartTime==i.slotStartTime});!!o&&n.pickSlots(o)}_.each(n.dateArray,function(e){e.selected=!1}),e.selected=!0,n.amSlots=n.slots.filter(function(e){return e.slotStartTime<720}),n.amSlotsMweb=[];for(var s=0;s<n.amSlots.length;s+=2)n.amSlotsMweb.push(n.amSlots.slice(s,s+2).map(function(e,t){return e}));n.pmSlots=n.slots.filter(function(e){return e.slotStartTime>=720}),n.pmSlotsMweb=[];for(var s=0;s<n.pmSlots.length;s+=2)n.pmSlotsMweb.push(n.pmSlots.slice(s,s+2).map(function(e,t){return e}))}}},n.pickSlots=function(e){_.each(n.slots,function(t,a){t.slotStartTime==e.slotStartTime?(t.selected=!0,c(function(){if(n.isMobileView){var e="AM"==n.slots[a].startTimeAmPm?"amGlider":"pmGlider";document.querySelector("#"+e).scrollLeft=70*a}},200)):t.selected=!1});var t=e.slotStartTime%60,a=0,i=0,r=Math.floor(e.slotStartTime/60),o=new Date(n.obj.prefDate);n.obj.prefDateTime=e.slotStartDateTime||new Date(o.getFullYear(),o.getMonth(),o.getDate(),r,t,a,i).toISOString(),n.obj.prefTime=e.slotStartTime,n.obj.servingProviders=e.servingProviders,n.obj.appointmentTimeTitle=e.startTime+" "+e.startTimeAmPm+" - "+e.endTime+" "+e.endTimeAmPm,n.obj.additionalInfo={},n.obj.slotObj=e,e.realtimePhlebo&&(n.obj.additionalInfo.realtimePhlebo=e.realtimePhlebo),e.slotDistributionForDate&&(n.obj.additionalInfo.slotDistributionForDate=e.slotDistributionForDate),e.slotDistributionForInterval&&(n.obj.additionalInfo.slotDistributionForInterval=e.slotDistributionForInterval),p.sendEvents("Labs Slot Time Selected",{timeSlot:JSON.stringify(n.obj.prefDateTime),timeSlotMeta:JSON.stringify(e),timeSlotSelected:JSON.stringify(o)})},n.$on("$destroy",function(){_.each(y,function(e,t){c.cancel(e),e&&(e.destroy(),y[t]=null)})})}}}]),e.register.directive("labsCard",["$rootScope","navConstantsSvc","authService","corpLabsService","$state","apiProvider","$httpParamSerializer","$stateParams","$timeout","notify","$location","$uibModal","$interval",function(e,t,a,i,n,r,o,s,c,l,d,p,u){return{restrict:"AE",scope:{sectionList:"=?",cardPipeline:"=?",srcPage:"=?",labsData:"=?",showDetailsPopUp:"=?"},terminal:!0,priority:1e6,templateUrl:"labtest/templates/labsCard.html?"+timeStamp,link:function(r,o,l){function p(){r.isMobileView=e.isMobileView,r.cardPipeline||(r.cardPipeline={}),r.sectionList||(r.sectionList=[]),r.labsData||(r.labsData={}),r.packagePipeline={show:!1},r.dialog=i.dialog,r.dialog.comparePackages=r.dialog.comparePackages&&(!k||k&&k.userDetails&&t.smartpackages.includes(k.userDetails.pmEntityID)),["ProviderTests"].includes(r.srcPage)&&r.cardPipeline.providerId&&(r.packagePipeline.providerId=r.cardPipeline.providerId),r.comparePackages=i.comparePackages,r.radiologyPage="/radiologyTests"==d.path(),r.labsCart=i.labsCart(),r.testsViewCount={current:5,max:5},r.providerDetail=["ProviderTests"].includes(r.srcPage),r.cardData={healthChecks:[],labTests:[],ltViewAll:!["LabsLanding","ProviderTests"].includes(r.srcPage),hcViewAll:!["ProviderTests"].includes(r.srcPage)},r.mergeList=i.labsCart(),r.cards={labTestsCard:r.sectionList.includes("labTests"),packagesCard:r.sectionList.includes("packages"),catgCard:r.sectionList.includes("categories")},r.categories={selCatg:s.catg||"",catgList:[],current:6,max:13},r.labTestFilter={filters:[],viewAll:!0},r.packageFilter={filters:[],viewAll:!0},u(),(r.categories.selCatg||["ProviderTests"].includes(r.srcPage))&&g(),"app.providerTests"==n.current.name&&(r.dialog.comparePackages=!1)}function u(){_.each(Array(5).fill(0),function(e){r.cardData.healthChecks.push({display:!1})}),_.each(new Array(5).fill(0),function(e){r.cardData.labTests.push({display:!1})})}function g(){var e={};r.categories.selCatg&&(r.cards.catgCard=!1,e={category:r.categories.selCatg.toUpperCase(),loadSubCategories:!0}),m(_.extend(r.cardPipeline.reqBody,e),r.sectionList)}function m(e,a){r.testsViewCount={current:5,max:5};var n=_.extend({ignoreLoader:!0},e),o=["ProviderTests"].includes(r.srcPage)&&r.cardPipeline.providerId?r.cardPipeline.fetchProviderTests():i.fetchPackagesListing(n);o.then(function(e){r.labsData.packages=e.packages,r.labsData.providerDetail=e.providerDetail,_.each(r.labsData.packages,function(e){e.display=!0}),f({"default":n.subCategory,data:e.subCategories},{"default":n.category,data:e.categories}),r.cardData.healthChecks=e.packages.filter(function(e){return e.contractId==t.healthCheckContract}),r.cardData.labTests=e.packages.filter(function(e){return e.contractId==t.labtestContract}),_.each(r.cardData.healthChecks,function(e){r.comparePackages.find(function(t){return t.packageId==e.packageId})?e.isCompared=!0:e.isCompared=!1}),r.testsViewCount.max=r.cardData.labTests.length,r.cards.packagesCard=!_.isEmpty(r.cardData.healthChecks),r.cards.labTestsCard=!_.isEmpty(r.cardData.labTests),v([],"+",!0);var a=0;_.isEmpty(r.packageFilter.filters)?c(function(){I&&I.refresh()},200):c(function(){r.onPackageFilterClick(r.packageFilter.filters[a])},200),_.isEmpty(r.labTestFilter.filters)||r.onlabTestFilterClick(_.first(r.labTestFilter.filters))})["catch"](function(){})}function f(e,a){if(_.isEmpty(e)||_.isEmpty(e.data)?(r.labTestFilter.filters=[],r.packageFilter.filters=[]):(r.labTestFilter.filters=_.isEmpty(e.data[t.labtestContract])?[]:e.data[t.labtestContract].map(function(t){return{label:t,value:t,selected:e["default"]&&e["default"]==t}}),r.packageFilter.filters=_.isEmpty(e.data[t.healthCheckContract])?[]:e.data[t.healthCheckContract].map(function(t){return{label:t,value:t,selected:e["default"]&&e["default"]==t}}),r.labTestFilter.viewAll=r.isMobileView,r.packageFilter.viewAll=r.isMobileView,_.each(r.packageFilter.filters,function(e){e.display=!0}),_.each(r.labTestFilter.filters,function(e){e.display=!0})),!_.isEmpty(a)&&!_.isEmpty(a.data)){var i=r.cardPipeline.reqBody.loadOnlyRadiology?"/assets/icons/corpLabs/categories/radiology/":"/assets/icons/corpLabs/categories/labtest/";a.data.length>6?(r.categories.catgList=a.data.map(function(e,t){return{label:e,value:e,imgSrc:i+e.toLowerCase().replace(" ","-")+".svg",show:t<5,"function":"chooseCategory"}}),r.categories.catgList.splice(5,0,{label:"View More...",value:"view",imgSrc:"/assets/icons/corpLabs/categories/radiology/arrow-down.svg",show:!0,"function":"changeCategoryView"}),r.categories.catgList.splice(r.categories.catgList.length,0,{label:"View Less...",value:"view",imgSrc:"/assets/icons/corpLabs/categories/radiology/arrow-up.svg",show:!1,"function":"changeCategoryView"})):r.categories.catgList=a.data.map(function(e,t){return{label:e,value:e,imgSrc:i+e.toLowerCase().replace(" ","-")+".svg",show:!0,"function":"chooseCategory"}}),r.categories.max=r.categories.catgList.length}}function v(e,t,a){var n=r.mergeList?_.union(r.mergeList.tests,r.mergeList.packages):[],o=["ProviderTests"].includes(r.srcPage)&&(!i.providerParams.providerSelected||i.providerParams.providerId!=r.cardPipeline.providerId);_.isEmpty(e)&&(e=n),_.each(r.cardData.labTests,function(i){var s=e.find(function(e){return e.packageId==i.packageId});s?(i.selected=!o&&"+"==t,i.cartId=s.cartId,i.showCount=!o&&r.cardPipeline.showBenefPopup?n.filter(function(e){return e.packageId==i.packageId}).length:0):a&&(i.selected=!1,i.cartId=0,i.showCount=0)}),_.each(r.cardData.healthChecks,function(i){var s=e.find(function(e){return e.packageId==i.packageId});s?(i.selected=!o&&"+"==t,i.cartId=s.cartId,i.showCount=!o&&r.cardPipeline.showBenefPopup?n.filter(function(e){return e.packageId==i.packageId}).length:0):a&&(i.selected=!1,i.cartId=0,i.showCount=0)})}function h(){c.cancel(I),I&&(I.destroy(),I=null,y=null)}window.updateSrc=!0;var b,k=a.isUserSignedin();p(),r.isCheckBoxEnabled=!1,r.comparePackages&&3==r.comparePackages.length&&(r.isCheckBoxEnabled=!0),r.addorremovepackage=function(e,t){if(t)i.addOrRemoveComparePages(e,"add");else{var a=r.comparePackages.findIndex(function(t){return t.packageId==e.packageId});i.addOrRemoveComparePages(e,"remove",a)}3==r.comparePackages.length?r.isCheckBoxEnabled=!0:r.isCheckBoxEnabled=!1},r.onFilterViewMore=function(e){e?r.packageFilter.viewAll=!0:r.labTestFilter.viewAll=!0},r.viewMoreTests=function(){var e=_.first(r.labTestFilter.filters.filter(function(e){return e.selected}));r.testsViewCount.current<r.testsViewCount.max?(i.sendEvents("View More Button Clicked",{serviceType:"labtest",filterType:e&&e.label}),_.each(r.cardData.labTests,function(e,t){t<r.testsViewCount.current||t>=r.testsViewCount.current+5||c(function(){r.testsViewCount.current+=1},t%5*30)}),c(function(){var e=document.getElementById("view-more-tests");e&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},100)):(c(function(){var e=document.getElementById("labTests-section");e&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},100),i.sendEvents("View Less Button Clicked",{serviceType:"labtest"}),_.each(r.cardData.labTests,function(e,t){t<5||(r.testsViewCount.current-=1)}))},r.onPackageFilterClick=function(e,a){a&&i.sendEvents("Labs Filters Clicked",{serviceType:"HealthCheckUps",filterType:e.label}),_.each(r.packageFilter.filters,function(t){t.selected=t.label==e.label}),r.cardData.healthChecks=r.labsData.packages.filter(function(a){return a.contractId==t.healthCheckContract&&a.subCategories.includes(e.value.toUpperCase())}),_.each(r.cardData.healthChecks,function(e){r.comparePackages.find(function(t){return t.packageId==e.packageId})?e.isCompared=!0:e.isCompared=!1});var n=r.cardData.healthChecks.filter(function(e){return!e.isAvailable});_.isEmpty(n)||i.sendEvents("Labs Non Serviceable",{serviceType:"HealthCheckUps",filterType:e.label},n),c(function(e){I&&I.refresh()})},r.onlabTestFilterClick=function(e,a){a&&i.sendEvents("Labs Filters Clicked",{serviceType:"LabTests",filterType:e.label}),_.each(r.labTestFilter.filters,function(t){t.selected=t.label==e.label}),r.cardData.labTests=r.labsData.packages.filter(function(a){return a.contractId==t.labtestContract&&a.subCategories.includes(e.value.toUpperCase())});var n=r.cardData.labTests.filter(function(e){return!e.isAvailable});_.isEmpty(n)||i.sendEvents("Labs Non Serviceable",{serviceType:"LabTests",filterType:e.label},n),r.testsViewCount.current=5,r.testsViewCount.max=r.cardData.labTests.length},r.onClickOfCategories=function(e){r.radiologyPage?i.sendEvents("Radiology Service Icons Clicked",{serviceType:e.label}):i.sendEvents("LabTests Service Icons Clicked",{serviceType:e.label}),r[e["function"]](e)},r.viewAllPackages=function(e){e?(i.sendEvents("View All Clicked",{serviceType:"healthcheck"}),n.go("app.consumerPackages",{filter:r.categories.selCatg})):(i.sendEvents("View All Clicked",{serviceType:"labtest"}),n.go("app.labTestsListing",{catg:r.categories.selCatg}))},r.filterCategories=function(e){return e.show},r.chooseCategory=function(e){n.go(n.current,{catg:e.value},{reload:!0})},r.changeCategoryView=function(){_.each(r.categories.catgList,function(e,t){t<r.categories.max&&t>=r.categories.current-1&&c(function(){e.show=!e.show},t%5*50)})},r.openPackageDetails=function(a){if(r.showDetailsPopUp)return i.sendEvents("PackageTestdetailspopup",{packageId:a.packageId,packageName:a.packageDisplayName,providerId:r.cardPipeline&&r.cardPipeline.providerId?r.cardPipeline.providerId:null,providerName:r.cardPipeline&&r.cardPipeline.providerName?r.cardPipeline.providerName:null}),r.packagePipeline.show=!0,void(r.packagePipeline.packageId=a.packageId);if(a.contractId==t.healthCheckContract)if(e.isMobileView)n.go("app.consumerPackages",{"package":a.packageId},{reload:!0});else{var o=window.location.origin;window.open(o+"/consumerPackages/"+a.packageId)}else if(e.isMobileView)n.go("app.consumerTests",{"package":a.packageId},{reload:!0});else{var o=window.location.origin;window.open(o+"/consumerTests/"+a.packageId+"/")}};var I=null,y=null;r.initializeGlider=function(){c(function(){var e="hc-glider";y=document.querySelector("#"+e),y&&(I=new Glider(y,{slidesToShow:r.isMobileView?1.1:2.9,slidesToScroll:r.isMobileView?1:1.1,draggable:!1,scrollLock:!0,skipTrack:!0,duration:1.5,arrows:!r.isMobileView&&{prev:".prev-"+e,next:".next-"+e}}))},10)};var S=e.$on("removedFromCompare",function(e,t){_.each(r.cardData.healthChecks,function(e){t==e.packageId&&(e.isCompared=!1)}),r.isCheckBoxEnabled=!1}),C=e.$on("clearCompare",function(e){_.each(r.cardData.healthChecks,function(e){e.isCompared=!1}),r.isCheckBoxEnabled=!1}),P=e.$on("addedToCompare",function(e,t){_.each(r.cardData.healthChecks,function(e){t==e.packageId&&(e.isCompared=!0)}),2==r.comparePackages.length&&(r.isCheckBoxEnabled=!0)}),w=e.$on("cartItemsUpdated",function(e,t){r.mergeList=i.labsCart(),v(t.cartItems,t.op,t.refresh)}),L=e.$on("userLocation",function(e,t){g(),r.pincode=t.pincode});r.$on("$destroy",function(e){h(),w(),L(),S(),C(),P(),c.cancel(b)})}}}]),e.register.directive("labsSearch",["$rootScope","navConstantsSvc","authService","corpLabsService","$state","apiProvider","$httpParamSerializer","$stateParams","$timeout","notify","$location","$uibModal","$interval","$sce",function(e,t,a,i,n,r,o,s,c,l,d,p,u,g){return{restrict:"AE",scope:{searchPipeline:"=?"},terminal:!0,priority:1e6,templateUrl:"labtest/templates/labsSearch.html?"+timeStamp,link:function(n,o,s){function c(){var e={isPopular:!0,contractIds:[t.healthCheckContract,t.labtestContract],ignoreLoader:!0},a=i.fetchPackagesListing(e);a.then(function(e){n.popularResults=e,n.mergeList.patients.length<=1&&u(n.mergeList.searchCart,"+",!0)})}function d(e,t,a){"-"==t?_.each(e,function(e){n.mergeList.searchCart=n.mergeList.searchCart.filter(function(t){return t.packageId!=e.packageId}),n.mergeList.totalSearchCost-=e.price}):"+"==t&&_.each(e,function(e){n.mergeList.searchCart.push(e),n.mergeList.totalSearchCost+=e.price}),u(e,t,a,[{key:"searchCartSel",val:"+"==t}]),m()}function u(e,t,a){var i=n.mergeList.searchCart;_.isEmpty(e)&&(e=i),_.each(n.searchVars.searchResults,function(i){var n=e.find(function(e){return e.packageId==i.packageId});i.searchCartSel=n?!!a||"+"==t:!a&&i.searchCartSel}),_.isEmpty(n.popularResults)||(_.each(n.popularResults.popularCovidTests,function(i){var n=e.find(function(e){return e.packageId==i.packageId});i.searchCartSel=n?!!a||"+"==t:!a&&i.searchCartSel}),_.each(n.popularResults.popularLabTests,function(i){var n=e.find(function(e){return e.packageId==i.packageId});i.searchCartSel=n?!!a||"+"==t:!a&&i.searchCartSel}),_.each(n.popularResults.popularHealthChecks,function(i){var n=e.find(function(e){return e.packageId==i.packageId});i.searchCartSel=n?!!a||"+"==t:!a&&i.searchCartSel}),n.showInSearch.covid=!_.isEmpty(n.popularResults.popularCovidTests)&&!!n.popularResults.popularCovidTests.find(function(e){return!e.searchCartSel}),n.showInSearch.tests=!_.isEmpty(n.popularResults.popularLabTests)&&!!n.popularResults.popularLabTests.find(function(e){return!e.searchCartSel}),n.showInSearch.packages=!_.isEmpty(n.popularResults.popularHealthChecks)&&!!n.popularResults.popularHealthChecks.find(function(e){return!e.searchCartSel})),_.each(n.descriptionMap,function(i){var n=e.find(function(e){return e.packageId==i.packageId});i.searchCartSel=n?!!a||"+"==t:!a&&i.searchCartSel})}function m(){n.mergeList.patients.length>1||n.mergeList.patients.length<=1&&_.isEmpty(n.mergeList.selectedList[n.mergeList.defaultPatId])?n.searchVars.cartText="Add To Cart":_.isEqual(n.mergeList.selectedList[n.mergeList.defaultPatId],n.mergeList.searchCart)?n.searchVars.cartText="Go To Cart":n.searchVars.cartText="Update Cart"}function f(e){var t=i.getPackageDetail(e);t.then(function(t){n.discountString=g.trustAsHtml("Upto <b>20% off</b>"),n.descriptionMap=t.descriptionMap,u(n.mergeList.searchCart,"+",!0),e&&n.showPackageDesc(e)})}function v(e,t){e&&a.makeAjaxCalls(r.apiUrl+"/Labs/Search/"+a.getCity()+"/"+a.getPincode()+"/"+e+"/10/"+(t?"true":"false"),"","GET",h.token,a.getCity(),!0).then(function(e){n.isLoading=!1,n.searchVars.searchResults=e.data.isSuccess?e.data.searchedItems:[],_.each(n.searchVars.searchResults,function(e){e.searchCartSel=!!n.mergeList.searchCart.find(function(t){return t.packageId==e.packageId})})},function(e){n.isLoading=!1,n.searchVars.searchResults=[],l({message:"There is some trouble loading in search results, please try again later",position:"center",duration:5e3})})}window.updateSrc=!0;var h=a.isUserSignedin();n.isMobileView=e.isMobileView,n.searchPipeline||(n.searchPipeline={},n.searchPipeline.dropdown=!1,n.searchVars.searchText=""),n.mergeList=i.labsCart(),n.searchVars={searchText:"",suggestedKeyword:"",cartText:"Go To Cart",searchResults:[]},n.showInSearch={},n.searchVars.placeholder=n.isMobileView?"Lab Tests, Scans, Packages":"Search for Lab Tests, Scans & Health Checkup Packages",n.descriptionMap={},n.dialog=i.dialog,n.dialog.comparePackages=n.dialog.comparePackages&&(!h||h&&h.userDetails&&t.smartpackages.includes(h.userDetails.pmEntityID)),n.clearText=function(e){n.searchVars.searchText="",n.searchVars.suggestedKeyword="",n.searchVars.searchResults=[],e&&e.stopPropagation()},c(),n.addItem=function(e,t,a){a&&a.stopPropagation(),e.patientId=n.mergeList.defaultPatId||0,i.sendEvents("Add To Cart Button Clicked",{CartSource:"Search"}),d(new Array(e),"+")},n.removeItem=function(e,t,a){a&&a.stopPropagation(),i.sendEvents("Remove From Cart Button Clicked",{CartSource:"Search"}),d(new Array(e),"-")},n.showPackageDesc=function(t,a){if(n.dialog.searchPopover=!1,n.descriptionMap[t])var i=p.open({animation:!0,backdrop:"none",template:'<div style="background-color:#fafcff" ng-class="{\'modal-bottom-header modal-header\':isMobileView,\'modal-body clearfix\':!isMobileView}"><div class="clearfix text-right"><span class="cursor-pointer" ng-style="{\'color\':isHover ? \'#000\' : \'#aaa\'}" ng-class="{\'md-dark-color\':isMobileView}"ng-init="isHover=false;" ng-mouseover="isHover=true;" ng-mouseout="isHover=false;" ng-click="cancelDialog($event)">close</span></div><ng-include src="\'package_desc.html\'"></ng-include></div></div>',scope:n,controller:["$scope","$uibModalInstance",function(e,a){e.packageDetail=n.descriptionMap[t],e.packageDetail.saleActive=!!e.packageDetail.discountInfo.discountPrice,e.cancelDialog=function(e){e&&e.stopPropagation(),a.dismiss("cancel")},i.result["catch"](function(){n.dialog.searchPopover=!0}),e.bodyFunctions=!1,e.diseasesCovered=!1,e.lifestyle=!1,e.toggleExpand=function(e,t){_.each(t.arrayFirstHalf,function(t){t.profileName!==e.profileName&&(t.expanded=!1)}),_.isEmpty(t.arraySecondHalf)||_.each(t.arraySecondHalf,function(t){t.profileName!==e.profileName&&(t.expanded=!1)}),e.expanded=!e.expanded}}],size:e.isMobileView?"bottom":"lg modal-border",windowClass:e.isMobileView&&"bottom-sheet"});else f(t)},n.debounceSearch=_.debounce(function(e){v(e)},800,!1),n.searchItems=function(e){n.searchVars.searchText=e,e&&e.length>1?(n.isLoading=!0,n.debounceSearch(e)):n.searchVars.searchResults=[]};var b=e.$on("cartItemsUpdated",function(e,t){n.mergeList=i.labsCart(),n.mergeList.patients.length<=1&&u(n.mergeList.searchCart,"+",!0)});n.$on("$destroy",function(e){b()})}}}]),e.register.directive("locationPopUp",["$rootScope","authService","apiProvider","$uibModal","$timeout","patternService","$state","corpLabsService","navConstantsSvc","$http","notify",function(e,t,i,n,r,o,s,c,l,d,p){return{restrict:"EA",scope:{disablePopup:"=?",step:"=?",showSavedOnly:"=?",customLocation:"=?"},templateUrl:"labtest/templates/locationPopUp.html?"+timeStamp,link:function(u){function g(){u.opened=!0,u.chosenAddressTag="",c.sendEvents("Location PopUp",{triggerdBy:t.getUserLocation()?"User":"System"}),c.dialog.locationPopup=!0,c.remLabsStickyHeader(),A=18,u.isMobileView?T=n.open({animation:!0,scope:u,backdrop:"none",templateUrl:"labtest/templates/mobileLocationPopUp.html?"+timeStamp,controller:["$scope","$uibModalInstance",function(e,t){M=t,e.cancelDialog=function(){t.dismiss("cancel"),y()}}],size:e.isMobileView?"bottom":"border",windowClass:e.isMobileView&&"bottom-sheet"}).closed.then(function(){y()}):r(function(){var e=document.getElementById("locsideBar"),t=document.getElementById("backDrop");e&&(e.classList.toggle("open"),t&&t.classList.toggle("open"))},300),u.confirmedLocation&&"SAVED_ADDRESS"==u.confirmedLocation.type&&u.confirmedLocation.addressId&&(u.chosenAddressTag=u.confirmedLocation.addressId),v(),u.showSavedOnly||f()}function m(a,i,n){var o=a?a:t.getCity(),s=i?i:t.getPincode(),l=n?n:t.getUserLocation();r(function(){u.$emit("selectedCity",{city:o,pincode:s,location:l}),u.$emit("pincodeChange",s),e.$emit("userLocation",l)},300),c.sendEvents("Location Submit",{locationchosenfrom:u.source})}function f(e){navigator.geolocation?(u.isLocationEnabled=!0,navigator.geolocation.getCurrentPosition(function(t){u.loading.gps=!1,u.usercurrentlat=t.coords.latitude,u.usercurrentlong=t.coords.longitude,e&&(b(t.coords.latitude,t.coords.longitude),u.map&&u.marker&&(u.marker.setPosition({lat:t.coords.latitude,lng:t.coords.longitude}),u.map.panTo({lat:t.coords.latitude,lng:t.coords.longitude}),u.map.setCenter({lat:t.coords.latitude,lng:t.coords.longitude}),u.map.setZoom(18)))},I,{maximumAge:1/0})):(u.loading.gps=!1,u.isLocationEnabled=!1)}function v(){if(u.savedAddresses=[],t.isUserSignedin())if(t.userAddresses&&t.userAddresses.length){var e=t.userAddresses.filter(function(e){return e.latitude&&e.longitude});e.forEach(function(e){u.savedAddresses.push({secondary_location:e.addressLine1+", "+e.addressLine2,primary_location:e.addressType,addressId:e.addressTag,icon:c.locationIcon(e.addressType),latitude:e.latitude,longitude:e.longitude,pincode:e.pincode,city:e.city,placeId:e.houseNo,type:"SAVED_ADDRESS"})})}else t.makeAjaxCalls(i.apiUrl+"/UserProfile",{fetchOnlyUserDetails:!0},"POST",u.user.token,null,!0).then(function(e){e.data.profile&&e.data.profile.userAddresses&&(t.userAddresses=e.data.profile.userAddresses.filter(function(e){return e.latitude&&e.longitude}),t.userAddresses.forEach(function(e){u.savedAddresses.push({secondary_location:e.addressLine1+", "+e.addressLine2,primary_location:e.addressType,addressId:e.addressTag,icon:c.locationIcon(e.addressType),latitude:e.latitude,longitude:e.longitude,pincode:e.pincode,city:e.city,placeId:e.houseNo,type:"SAVED_ADDRESS"})}))})["catch"](function(e){})}function h(e){var a=i.apiUrl+"/Labs/v1/FetchCityByPincode/"+e;u.loading.servicable=!0,u.error.servicable=!1,u.servicability=!1,t.makeAjaxCalls(a,"","GET",u.user.token,t.getCity(),!0).then(function(t){u.loading.servicable=!1,D&&t.data.isRetailPackagesAvailable||!D&&t.data.isSuccess?t.data.city&&(u.servicability=!0,u.newcity=t.data.city,u.newpincode=e,c.sendEvents("Pincode Verification",{pincode:e,locationchosenfrom:u.source}),u.selectedLocation&&!u.selectedLocation.city&&(u.selectedLocation.city=t.data.city),"SAVED_ADDRESS"==u.source&&u.confirmLocation()):(u.servicability=!1,
c.sendEvents("Pincode Not Servicable",{locationchosenfrom:u.source}),c.sendEvents("Location Unserviceable",{nonservicablePincode:e,nonservicableLatitute:u.selectedLocation.latitude,nonservicableCity:t.data&&t.data.city?t.data.city:"",nonservicableLongitude:u.selectedLocation.longitude,locationchosenfrom:u.source}),u.errorMessage="Sorry! We are not serviceable in "+e+" location. Please try another pincode")})["catch"](function(t){c.sendEvents("Location Unserviceable",{nonservicablePincode:e,nonservicableLatitute:u.selectedLocation.latitude,nonservicableCity:"No City",nonservicableLongitude:u.selectedLocation.longitude,locationchosenfrom:u.source}),u.loading.servicable=!0,u.error.servicable=!0,u.servicability=!1,503==t.status?(c.sendEvents("Pincode Not Servicable",{locationchosenfrom:u.source}),u.errorMessage="Sorry! We are not serviceable in "+e+" location. Please try another pincode"):u.errorMessage="There is an error fetching the details. Please try again or after sometime."})}function b(e,t,a){var i=new google.maps.Geocoder,n={lat:parseFloat(e),lng:parseFloat(t)},r={};a?r.placeId=a:(e||t)&&(r.location=n),i.geocode(r,function(a,i){if(i===google.maps.GeocoderStatus.OK)for(var n=null,r=0;r<a.length;r++){const o=a[r];if(o.address_components&&o.address_components.forEach(function(e){if(e.types.includes("postal_code"))return void(n=o)}),n){var s="";const l=["sublocality_level_2","sublocality_level_1","sublocality","administrative_area_level_2","administrative_area_level_1"];for(var d=0;d<l.length;d++)if(_.find(n.address_components,function(e){return e.types.includes(l[d])})){s=_.find(n.address_components,function(e){return e.types.includes(l[d])}).long_name;break}return u.selectedLocation={pincode:_.find(n.address_components,function(e){return e.types.includes("postal_code")}).long_name,latitude:e,longitude:t,primary_location:s,secondary_location:n.formatted_address,placeId:n.place_id,type:"SEARCH"},void u.placesClick(u.selectedLocation,"SEARCH")}}else c.sendEvents("GeoCoder Error",{status:i,errorMessage:"Geocoder Failure"})},function(e){c.sendEvents("GeoCoder Catch Block")})}function k(e,t,a,i,n){if(i||(i=A),document.getElementById(e)){var r={lat:t,lng:a};u.map&&u.marker&&(u.marker.setPosition({lat:t,lng:a}),u.map.setZoom(18)),u.map=new google.maps.Map(document.getElementById(e),{center:r,zoom:i,clickableIcons:!1,gestureHandling:n,disableDefaultUI:!0,restriction:{latLngBounds:{north:37.1,south:8.05,west:68.12,east:97.4},strictBounds:!1}});var o={url:"/assets/icons/location/pin.svg",scaledSize:new google.maps.Size(25,37.74)};u.marker=new google.maps.Marker({icon:o,position:r,map:u.map,animation:google.maps.Animation.DROP,name:"Location"}),2==u.step&&(google.maps.event.addListener(u.map,"center_changed",function(){var e=this.getCenter(),t=e.lat(),a=e.lng();u.marker.setPosition({lat:t,lng:a})}),google.maps.event.addListener(u.map,"dragend",function(){var e=this.getCenter(),t=e.lat(),a=e.lng();c.sendEvents("Drag Map",{locationchosenfrom:u.source}),u.debounceMarker(t,a)}))}}function I(e){switch(u.loactionErrormsg="",u.isLocationEnabled=!1,u.loading.gps=!1,u.errorType=e.code,e.code){case e.PERMISSION_DENIED:u.loactionErrormsg="User denied the request for Geolocation.";break;case e.POSITION_UNAVAILABLE:u.loactionErrormsg="Location information is unavailable.";break;case e.TIMEOUT:u.loactionErrormsg="The request to get user location timed out.";break;default:u.loactionErrormsg="An unknown error occurred."}c.sendEvents("Location Permission Denied",{loactionErrormsg:u.loactionErrormsg})}function y(){u.opened=!1,c.dialog.locationPopup=!1;var e=document.getElementById("locsideBar"),a=document.getElementById("backDrop");e&&e.classList.toggle("open"),a&&a.classList.toggle("open"),M&&M.dismiss("cancel"),r(function(){u.step=1,u.searchText.value="",u.map=null,u.marker=null,u.currentLocationMarker=null,u.searchedresult=[],u.showSavedOnly=!1,u.changeSavedAddress=!1,c.dialog.locationPopup=!1,u.limit={addresses:3,reacentsearches:3},c.dialog.labsFixedHeader&&c.addLabsStickyHeader(),t.getPincode()&&t.getCity()&&t.getUserLocation()||L()},450)}function S(e,a){u.addoreditaddressInfo={submitted:!1},c.sendEvents("Add new Address"),u.step=3,u.isAdd=!!e,u.opened||g();var i;i=a?a:t.getUserLocation(),u.othersTag=!1,u.newAddressInfo={city:i.city,pincode:i.pincode,addressType:i.tag?i.tag:"Home",addressLine2:i.secondary_location?i.secondary_location:"",addressLine1:e?"":i.primary_location,latitude:i.latitude?i.latitude:"",longitude:i.longitude?i.longitude:"",houseNo:i.placeId?i.placeId:"",isPrimary:!0,isActive:!0},r(function(){u.newAddressInfo.latitude&&u.newAddressInfo.longitude&&k("google-map-readonly",u.newAddressInfo.latitude,u.newAddressInfo.longitude,18,"none")},350)}function C(){u.step=1,u.limit={addresses:100},u.showSavedOnly=!0,u.opened||g()}function P(e,a){if(u.userProfile=t.profileInfo,u.userProfile&&_.isEmpty(u.userProfile.userAddresses)&&(u.userProfile.userAddresses=[]),e){var n=u.userProfile.userAddresses.find(function(t){return t.addressTag==e});_.extend(n,u.newAddressInfo)}else{var r=_.extend({},u.newAddressInfo);delete r.addressTag,u.userProfile.userAddresses.push(_.extend({},r))}var o=_.map(t.userAddresses,function(e){return e.addressTag}),l=i.apiUrl+"/UpdateProfile.json";t.makeAjaxCalls(l,u.userProfile,"POST",u.user.token,null,a).then(function(a){if(a.data.isSuccess&&a.data.profile){u.userProfile=a.data.profile,t.profileInfo=a.data.profile,t.userAddresses=a.data.profile.userAddresses.filter(function(e){return e.latitude&&e.longitude});var i=_.map(t.userAddresses,function(e){return e.addressTag}),n=_.first(_.difference(i,o)),r=_.find(a.data.profile.userAddresses,function(e){return e.addressTag==n});c.sendEvents("Submit Address"),v(),e||"app.consumerLabsCheckout"!==s.current.name||(r?u.placesClick({secondary_location:r.addressLine1+", "+r.addressLine2,primary_location:r.addressType,addressId:r.addressTag,icon:c.locationIcon(r.addressType),latitude:r.latitude,longitude:r.longitude,pincode:r.pincode,city:r.city,placeId:r.houseNo,type:"SAVED_ADDRESS"},"SAVED_ADDRESS"):C())}else p({message:"Sorry! Please try again after sometime.",position:"center",duration:5e3})})}function w(){u.noPincode=!1,u.confirmedLocation=l.defaultLabsLocation,t.setUserLocation(u.confirmedLocation),t.setPincode("560029"),t.setCity("Bengaluru"),m("Bengaluru","560029",u.confirmedLocation)}function L(){B=n.open({animation:!0,scope:u,backdrop:"static",templateUrl:"labtest/templates/defaultLocation.html?"+timeStamp,controller:["$scope","$uibModalInstance",function(e,t){e.confirm=function(){w(),t.dismiss("cancel")},e.changeLocation=function(){t.dismiss("cancel"),u.noPincode=!0,g()}}],size:e.isMobileView?"bottom":"border modal-sm",windowClass:e.isMobileView&&"bottom-sheet"}).closed.then(function(){})}function E(t,a){c.sendEvents("Change location permission pop-up"),y(),$=n.open({animation:!0,scope:u,backdrop:"static",templateUrl:"labtest/templates/changeLocation.html?"+timeStamp,controller:["$scope","$uibModalInstance",function(e,i){e.current_location=t,e.new_location=a,e.cancelDialog=function(){i.dismiss("cancel"),c.sendEvents("Change location permission response",{Popup_response:"Cancel"})},e.confirm=function(){u.confirmLocation(!0),c.sendEvents("Change location permission response",{Popup_response:"Changelocation"}),s.go("app.consumerCart")}}],size:e.isMobileView?"bottom":"border modal-sm",windowClass:e.isMobileView&&"bottom-sheet"}).closed.then(function(){})}u.user=t.isUserSignedin(),u.isMobileView=e.isMobileView,u.patternCheck=o,u.isIOS=/iphone|ipod|ipad/.test(window.navigator.userAgent.toLowerCase()),u.isLocationEnabled=!1,u.searchedresult=[],u.step=1,u.searchText={value:""},u.source="";var D=!!_.isEmpty(u.user)||u.user.isRetailUser;u.loading={placessearch:!1,addresses:!1,maps:!1,gps:!1,servicable:!1},u.recentSearches=_.isEmpty(t.getRecentSearches())?[]:t.getRecentSearches(),u.error={placessearch:!1,addresses:!1,maps:!1,servicable:!1},u.limit={addresses:3,reacentsearches:3},u.addressInfo={addressLine1:"",addressLine2:"",pincode:t.getPincode(),city:t.getCity(),isSelected:!1,isActive:!0,addressType:"Home"},u.form={};var A=18,T="",B=null,$=null,M=null;u.noPincode=!1,t.getPincode()&&t.getCity()&&t.getUserLocation()?(u.confirmedLocation=t.getUserLocation(),m()):(u.noPincode=!0,g()),u.confirmLocation=function(e){if(u.servicability&&u.newcity&&u.newpincode){if("app.consumerLabsCheckout"===s.current.name&&!e){if("SAVED_ADDRESS"!=u.selectedLocation.type&&u.savedAddresses.length>0)return void S(!0,u.selectedLocation);var a=t.getUserLocation();if(a.pincode!=u.selectedLocation.pincode)return void E(a,u.selectedLocation)}t.setPincode(u.newpincode),t.setCity(u.newcity),t.setUserLocation(u.selectedLocation),m(u.newcity,u.newpincode,u.selectedLocation),y(),u.confirmedLocation=u.selectedLocation,u.noPincode=!1}},u.validate=function(e,t){var a=new RegExp(u.patternCheck.getRegexExpression(t)),i=String.fromCharCode(e.charCode?e.charCode:e.which);if(!a.test(i)&&13!==e.charCode&&9!==e.charCode)return e.preventDefault(),!1},u.clearSearch=function(e,t){u.searchText.value="",t="",u.searchedresult=[],e&&e.stopPropagation()},u.detectLocation=function(){u.loading.gps||(u.loading.gps=!0,"$apply"!=u.$root.$$phase&&"$digest"!=u.$root.$$phase&&u.$apply(),f(!0))},u.zoom=function(e){if(!(A<=6)){switch(e){case"INCR":A+=1;break;case"DEC":A-=1}u.map&&u.map.setZoom(A)}},u.placesClick=function(e,a){if(e.type||(e.type=a),u.selectedLocation=e,u.source=a,1==u.step&&"SAVED_ADDRESS"!=a)u.step=2,A=18,u.selected_PL=e.primary_location,u.selected_SL=e.secondary_location,"SEARCH"==a&&(u.recentSearches.push(e),u.recentSearches=_.uniq(u.recentSearches,function(e){return e.placeId}),t.setRecentSearches(u.recentSearches)),r(function(){k("google-map",e.latitude,e.longitude,A,"auto")},350);else if(2==u.step)u.selected_PL=e.primary_location,u.selected_SL=e.secondary_location;else if("SAVED_ADDRESS"==a&&u.chosenAddressTag==e.addressId)return;h(e.pincode)},u.debounceMarker=_.debounce(function(e,t){b(e,t)},300,!1),u.debounceSearch=_.debounce(function(e){u.searchedresult=[],u.loading.placessearch=!0,u.error.placessearch=!1,d({method:"GET",url:"https://location-service.medibuddy.in/places-search?searchText="+e,headers:{platform:"web","x-mb-api-key":"E3CA3E8F-6E62-440C-BC80-D2479EC471C2","x-mb-source":"web"},ignoreLoadingBar:!0}).then(function(e){u.loading.placessearch=!1,u.error.placessearch=!1,e.data.success&&e.data.results&&!_.isEmpty(e.data.results)&&(u.searchedresult=[],e.data.results.forEach(function(e){u.searchedresult.push({pincode:e.pincode,primary_location:e.primaryText,secondary_location:e.secondaryText,placeId:e.placeId,latitude:e.latitude,longitude:e.longitude})}))})["catch"](function(t){u.loading.placessearch=!1,u.error.placessearch=!0,c.sendEvents("Failure in Places Search",{searchText:e})})},1e3,!1),u.searchItems=function(e){u.searchText.value=e,u.searchedresult=[],e&&e.length>3?u.debounceSearch(e):u.searchedresult=[]},u.openLocationPopUp=function(){u.disablePopup||(c.sendEvents("Change Location"),g())},u.goBack=function(){u.step=1,u.selected_PL="",u.selected_SL="",u.map=null,u.marker=null,u.limit={addresses:3,reacentsearches:3},u.currentLocationMarker=null},u.resetScreen=function(e){u.step=e||1,u.limit={addresses:3,reacentsearches:3},u.showSavedOnly=!1,u.changeSavedAddress=!1,f()},u.switchBoolen=function(e){u[e]=!u[e]},u.changeAddressTag=function(e){u.newAddressInfo&&"Others"!=e?(u.newAddressInfo.addressType=e,u.othersTag=!1):"Others"==e&&(u.othersTag=!0,u.newAddressInfo.addressType="")},u.addorupdateAddress=function(){if(u.addoreditaddressInfo.submitted=!0,u.addoreditaddressInfo.newaddressForm&&!u.addoreditaddressInfo.newaddressForm.$valid){var e=a.element(document.querySelector("input.ng-invalid"));return void(e&&!_.isEmpty(e)&&e[0].focus())}u.isAdd&&P(!1,!1)},u.backDrropClicked=function(){y(),u.$emit("onBackDropClicked")},e.$on("DefaultLocationSet",function(){u.noPincode=!1,u.confirmedLocation=t.getUserLocation(),m()}),u.$on("$destroy",function(){y()}),u.$on("showSavedAdresses",function(){C()}),u.$on("changeSavedAddress",function(){u.changeSavedAddress=!0,C()}),u.$on("changeLocation",function(){u.step=1,g()}),u.$on("addNewAddress",function(e,t){S(t)})}}}]),e.register.directive("packageDetails",["$rootScope","navConstantsSvc","authService","corpLabsService","$state","apiProvider","$stateParams","$timeout","notify","$uibModal","standardEventsSvc",function(e,t,a,i,n,r,o,s,c,l,d){return{restrict:"EA",scope:{pipeline:"=?",showDetailsOnly:"=?"},terminal:!0,priority:1e6,link:function(n,r,o){function s(){u=l.open({animation:!0,backdrop:"none",templateUrl:"labtest/templates/packageDetailsPopUp.html?"+timeStamp,scope:n,controller:["$scope","$uibModalInstance",function(e,a){function r(){n.packageDetail.saleActive=!!n.packageDetail.discountInfo.discountPrice}function o(){var e=_.union(n.mergeList.tests,n.mergeList.packages),a=_.groupBy(e,"packageId");if(n.packageDetail.packageCountInCart=a[n.pipeline.packageId]?a[n.pipeline.packageId].length:0,n.packageDetail.selected=!1,n.pipeline.contractId==t.ahcContract)if(n.pipeline.patientId){var i=_.find(e,function(e){return e.packageId==n.pipeline.packageId&&e.patientId==n.pipeline.patientId});i&&(n.packageDetail.selected=!0,n.packageDetail.cartId=i.cartId,n.packageDetail.cartIds=i.cartIds)}else n.packageDetail.selected=!1,n.packageDetail.cartId=0,n.packageDetail.cartIds=[];else if(1==n.packageDetail.packageCountInCart){var i=_.find(e,function(e){return e.packageId==n.pipeline.packageId});n.packageDetail.selected=!0,n.packageDetail.cartId=i.cartId,n.packageDetail.cartIds=i.cartIds}}e.isLoading=!0,e.bodyFunctions=!1,e.diseasesCovered=!1,e.lifestyle=!1;var s=i.getPackageDetail(n.pipeline.packageId,n.pipeline.providerId,n.pipeline.patientId);s.then(function(t){e.isLoading=!1,n.packageDetail=t.descriptionMap[n.pipeline.packageId],i.sendEventsV1(d.LABS_PACKAGE_DETAILS_SCREEN_LANDING,{package_id:n.packageDetail.packageId.toString(),package_name:n.packageDetail.packageName,isSponsored:n.packageDetail.isSponsored,isServiceable:n.packageDetail.isAvailable,isHybridPackagePresent:n.packageDetail.packageSplit&&n.packageDetail.packageSplit.isHybrid}),e.providerDetail=t.providerDetail||null,r(),o()})["catch"](function(t){e.isLoading=!1,c({message:"Sorry! Unable to load Package Details, Please try after some time",position:"center",duration:5e3}),e.cancelDialog()}),e.cancelDialog=function(e){e&&e.stopPropagation(),a.dismiss("cancel")},e.toggleExpand=function(e,t){_.each(t.arrayFirstHalf,function(t){t.profileName!==e.profileName&&(t.expanded=!1)}),_.isEmpty(t.arraySecondHalf)||_.each(t.arraySecondHalf,function(t){t.profileName!==e.profileName&&(t.expanded=!1)}),e.expanded=!e.expanded},e.addItem=function(e){(_.isNull(e.patientId)||0==e.patientId)&&n.pipeline.patientId&&(e.patientId=n.pipeline.patientId),n.showBenefPopUp||n.pipeline.showFamilyPopUp||(i.sendEvents("Add To Cart Button Clicked",{CartSource:p},new Array(e)),i.addItemsToCart(new Array(e),"+",!1,!!n.user,{screen:p}))},e.removeItem=function(e){i.sendEvents("Remove From Cart Button Clicked",{CartSource:p},new Array(e)),i.addItemsToCart(new Array(e),"-",!1,!!n.user)}}],size:e.isMobileView?"bottom":"lg modal-border",windowClass:e.isMobileView&&"bottom-sheet"}).closed.then(function(){n.pipeline.show=!1,n.pipeline={}})}var p="Package Details Pop Up";if(n.user=a.isUserSignedin(),n.isMobileView=e.isMobileView,n.isRetailUser=n.user.isRetailUser||!n.user,!_.isEmpty(n.pipeline)&&n.pipeline.show){n.packageDetail=null,n.familyPipeline={show:!1},_.isEmpty(n.user)?i.getCartLS():i.getCartDetails();var u=null,g=e.$on("cartItemsUpdated",function(e,a){n.mergeList=i.labsCart(),n.showBenefPopUp=(!n.pipeline.patientId||n.pipeline.contractId!=t.ahcContract)&&n.mergeList.patients.length>1,n.pipeline.showFamilyPopUp&&(n.showBenefPopUp=!0);var r=_.find(_.union(n.mergeList.tests,n.mergeList.packages),function(e){return e.packageId==n.pipeline.packageId&&e.patientId==n.pipeline.patientId});r&&n.packageDetail?(n.packageDetail.selected=!!r,n.packageDetail.cartId=r.cartId,n.packageDetail.cartIds=r.cartIds):n.packageDetail&&(n.packageDetail.selected=!1,n.packageDetail.cartId=0,n.packageDetail.cartIds=[]);var o=_.union(n.mergeList.tests,n.mergeList.packages).filter(function(e){return e.isPresentInCart&&e.contractId==t.ahcContract}),c="none";_.isEmpty(o)||(c=o.find(function(e){return!e.isHomeSampleAvailable})?"lab":"home"),n.pipeline.contractId==t.ahcContract&&"none"!=c&&("lab"==c&&n.pipeline.isHomeSampleAvailable&&(n.showDetailsOnly=!0),"home"!=c||n.pipeline.isHomeSampleAvailable||(n.showDetailsOnly=!0)),u||s()});n.$on("$destroy",function(e){g(),n.pipeline={}})}}}}]),e.register.directive("providerDetail",["$rootScope","authService","apiProvider","$uibModal","$timeout","patternService","$state","corpLabsService","navConstantsSvc","$stateParams",function(e,t,a,i,n,r,o,s,c,l){return{restrict:"EA",scope:{providerPipeline:"=?",showTitle:"=?"},templateUrl:"labtest/templates/providerDetail.html?"+timeStamp,link:function(i){function r(e){e||i.providerPipeline.providerDetails||(e=i.providerPipeline.providerDetails);var t={loginstatus:!0,providerFlow:!i.isCheckout};return e&&(t.providerId=e.providerId,t.providerName=e.providerName,t.Recommended=e.isRecommended,t.photosAvailable=e.hasOwnProperty("providerProperties")&&e.providerProperties.hasOwnProperty("provierImages")&&e.providerProperties.length>0,t.distanceFromUser=e.distance,t.provideLocationAvailable=e.hasOwnProperty("distance"),t.Trusted=e.providerProperties.isTrusted,t["NABL Certified"]="NABL Certified"==e.label,t["NABH Certified"]="NABH Certified"==e.label),t}function d(){i.totRatings=0,i.providerPipeline.providerDetails.providerProperties.ratings&&(i.totRatings=_.reduce(i.providerPipeline.providerDetails.providerProperties.ratings,function(e,t){return e+t.count},0),_.each(i.providerPipeline.providerDetails.providerProperties.ratings,function(e){i.ratings[e.rating-1].count=e.count,i.ratings[e.rating-1].percentage=e.count/i.totRatings*100}),i.avgrating=_.reduce(i.ratings,function(e,t){return e+t.rating*t.count},0)/i.totRatings,i.avgrating=Math.round(100*i.avgrating)/100,i.avgrating<=3&&(i.avgrating=0,i.totRatings=0)),i.providerPagePhoto=[],i.providerPipeline.providerDetails&&i.providerPipeline.providerDetails.providerProperties.provierImages&&i.providerPipeline.providerDetails.providerProperties.provierImages.length&&(i.providerPagePhoto=_.pluck(_.sortBy(i.providerPipeline.providerDetails.providerProperties.provierImages,"order").filter(function(e){return e.isActive}),"imageUrl")),n(function(){i.providerPipeline.providerDetails.locationInfo&&i.providerPipeline.providerDetails.locationInfo.providerLocationLatitude&&i.providerPipeline.providerDetails.locationInfo.providerLocationLongitude&&p("provider-location",i.providerPipeline.providerDetails.locationInfo.providerLocationLatitude,i.providerPipeline.providerDetails.locationInfo.providerLocationLongitude)},400)}function p(e,t,a){if(document.getElementById(e)){i.pos[e]={lat:parseFloat(t),lng:parseFloat(a)},i.map[e]=new google.maps.Map(document.getElementById(e),{center:i.pos[e],zoom:16,clickableIcons:!1,disableDefaultUI:!0,gestureHandling:"none",restriction:{latLngBounds:{north:37.1,south:8.05,west:68.12,east:97.4},strictBounds:!1}});var n={url:"/assets/icons/location/pin.svg",scaledSize:new google.maps.Size(25,37.74)};i.marker=new google.maps.Marker({icon:n,position:i.pos[e],map:i.map[e],animation:"providermaps"==e?google.maps.Animation.BOUNCE:google.maps.Animation.DROP,name:"Location"})}}i.isMobileView=e.isMobileView;var u=16;i.showRatings=c.showRatings,i.providerPipeline||(i.providerPipeline={}),console.log(i.providerPipeline),i.providerId=l.providerId||i.providerPipeline.providerId,i.isCheckout=o.includes("app.consumerLabsCheckout"),i.ratings=[{rating:1,count:0,percentage:0},{rating:2,count:0,percentage:0},{rating:3,count:0,percentage:0},{rating:4,count:0,percentage:0},{rating:5,count:0,percentage:0}],i.loading=!1,i.sections=[{title:"Amenities",selected:!1,isActive:!0,value:"amenitites"},{title:"Map & Directions",selected:!1,isActive:!0,value:"location"},{title:"Rating & Reviews",selected:!1,isActive:!1,value:"ratings"}],_.isEmpty(i.providerPipeline.providerDetails)?(i.loading=!0,t.makeAjaxCalls(a.apiUrl+"/Labs/v1/FetchProviderDetails",{providerIds:[i.providerId]},"POST").then(function(e){i.loading=!1,e.data.isSuccess&&!_.isEmpty(e.data.providers)&&(i.providerPipeline.providerDetails=_.find(e.data.providers,function(e){return e.providerId==i.providerId}),d())})["catch"](function(e){i.loading=!1})):d(),i.gliderClick=function(){s.sendEvents("Image slider clicked in PDP",r(i.providerPipeline.providerDetails))},i.viewMap=function(){s.sendEvents("View Provider on Map",r()),i.opened=!0,i.backDrropClicked()},i.backDrropClicked=function(e){n(function(){var t=document.getElementsByClassName("locationsidebar"),a=document.getElementById("backDrop");t&&(t[0].classList.toggle("open"),a&&a.classList.toggle("open"),e?i.opened=!1:p("providermaps",i.providerPipeline.providerDetails.locationInfo.providerLocationLatitude,i.providerPipeline.providerDetails.locationInfo.providerLocationLongitude))},100)},i.onSectionClick=function(e){_.each(i.sections,function(t){t.selected=t.title==e.title});var t=document.getElementById(e.value);t&&t.scrollIntoView({behavior:"smooth",block:"start",inline:"center"})};var g={},m={},f={};i.initializeGlider=function(e){f[e]=n(function(){g[e]=document.querySelector("#"+e),g[e]&&(m[e]=new Glider(g[e],{slidesToShow:i.isMobileView?1.1:1,slidesToScroll:1,draggable:!1,skipTrack:!0,scrollLock:!0,arrows:!i.isMobileView&&{prev:".prev-"+e,next:".next-"+e},dots:i.isMobileView&&"#dots-"+e}))},300)},i.imageClick=function(e){s.sendEvents("Image slider clicked in PDP",r()),m.providerImages&&m.providerImages.scrollItem(e)},i.map={},i.pos={},i.zoom=function(e,t){if(!(u<=6)){switch(t){case"INCR":u+=1;break;case"DEC":u-=1}i.map[e]&&i.map[e].setZoom(u)}},i.$on("$destroy",function(){i.providerPipeline={}})}}}]),e.register.directive("providerPackages",["$rootScope","navConstantsSvc","authService","corpLabsService","$state","apiProvider","$httpParamSerializer","$stateParams","$timeout","notify","$location","$uibModal","$interval","$http",function(e,t,a,i,n,r,o,s,c,l,d,p,u,g){return{restrict:"AE",scope:{providerDetails:"=?"},terminal:!0,priority:1e6,templateUrl:"labtest/templates/providerPackages.html?"+timeStamp,link:function(n,o,s){function l(){_.isEmpty(a.mergeCart)?(n.mergeList={selectedList:{},patients:[],tests:[],packages:[],isLabVisit:!1,totalPrice:0,totalPriceRange:0},i.getCartDetails()):(n.mergeList=a.mergeCart,i.getCartDetails())}function d(){n.mergeList.isLabVisit=!!_.union(n.mergeList.tests,n.mergeList.packages).find(function(e){return e.isAvailable&&!e.isHomeSampleAvailable})}function u(e){_.isEmpty(e)&&(e=_.union(n.mergeList.packages,n.mergeList.tests)),n.mergeList.totalPrice=_.pluck(e,"price").reduce(function(e,t){return e+t},0),n.mergeList.totalPriceRange=_.pluck(e,"priceRange").reduce(function(e,t){return e+t},0),n.mergeList.totalDiscount=Math.floor(100-100*n.mergeList.totalPrice/n.mergeList.totalPriceRange)}function m(t,a){var r=p.open({animation:!0,backdrop:"none",templateUrl:"labtest/templates/replaceCart.html?"+timeStamp,scope:n,controller:["$scope","$uibModalInstance",function(e,o){e.closeModal=function(e){e&&e.stopPropagation(),o.dismiss("cancel"),r=null},e.confirmText={first:i.providerParams.providerSelected?"Your Cart contains test/packages from ":"You already have an existing cart.",second:i.providerParams.providerSelected?i.providerParams.providerName+".":"",third:"Do you want to discard the selection and add test/Packages from",fourth:n.providerDetails.providerName+"?"},e.confirmReplace=function(n){n&&n.stopPropagation(),i.sendEvents("Add to cart",{providerFlow:!0,contractId:9716}),i.addItemsToCart([t],"+",!0,!0,a),e.closeModal()}}],size:e.isMobileView?"bottom":"border modal-md",windowClass:e.isMobileView&&"bottom-sheet"})}function f(e){var t;e&&(t=e),!t&&v&&v.userDetails&&(t=r.staticUrl+"static/corpLogo/"+v.userDetails.pmEntityID+".png"),t&&g.get(t,{responseType:"blob"}).then(function(e){var t=new FileReader;t.readAsDataURL(e.data),t.onload=function(e){n.logoUrl=e.target.result}})["catch"](function(e){n.logoUrl="assets/icons/ahc/default-corp-logo.svg"})}n.isMobileView=e.isMobileView;var v=a.isUserSignedin();n.packagePipeline={show:!1};var h,b;n.pincode=a.getPincode(),n.initializeGlider=function(e){var t=e;c(function(){h=document.querySelector("#"+t),h&&(b=new Glider(h,{slidesToShow:n.isMobileView?1.05:3,slidesToScroll:n.isMobileView?1:3,draggable:!1,skipTrack:!0,scrollLock:!0,arrows:{prev:".prev-"+t,next:".next-"+t},dots:!1}))},0)};var k={currentProvider:parseInt(n.providerDetails.providerId)};k.providerChange=i.providerParams.providerSelected&&i.providerParams.providerId!=k.currentProvider,n.logoUrl=f(),n.hideSelected=!i.providerParams.providerSelected||i.providerParams.providerId!=n.providerDetails.providerId,n.init=function(){n.loading=!0,n.selectedBenef={},n.selectedBenef.packages=[],_.each(Array(1).fill(0),function(e){n.selectedBenef.packages.push({display:!1})}),n.error=!1,a.makeAjaxCalls(r.apiUrl+"/Labs/v1/FetchCorporatePackages",{fetchRetailPackages:!1,providerId:n.providerDetails.providerId},"POST",v.token,!1).then(function(e){if(e.data.isSuccess){n.logoUrl=f(e.data.corporateLogo),n.beneficiaries=e.data.employeeDetail.beneficiaries,!_.isEmpty(n.beneficiaries)&&_.isArray(n.beneficiaries)&&_.each(n.beneficiaries,function(e){e.sponsoredAvailable=!1,e.icon=i.getGenderIcon(e.maid,e.gender,e.age),_.each(e.packages,function(a){a.tests=[],_.isEmpty(a.availableProfiles)||(a.tests=a.tests.concat(_.pluck(a.availableProfiles,"availableTests"))),_.isEmpty(a.availableTests)||(a.tests=a.tests.concat(a.availableTests)),e.sponsoredAvailable=e.sponsoredAvailable||a.isSponsored,a.tests=_.flatten(a.tests),a.testCount=a.tests.length,a.contractId=t.ahcContract})}),n.selectedBenef=n.beneficiaries[0],_.each(n.selectedBenef.packages,function(e){e.display=!0}),n.selectedBenef.selected=!0;var a={paidPackageCount:_.uniq(_.compact(_.flatten(_.pluck(n.beneficiaries,"paidPackage")))).length,sponsoredPackageCount:_.uniq(_.compact(_.flatten(_.pluck(n.beneficiaries,"sponsPackage")))).length};i.sendEvents("Corp Benefits Loaded",a),l()}else i.sendEvents("Corporate benefits loading failed"),n.error=!0;n.loading=!1,c(function(e){b&&b.refresh(!0)},0)})["catch"](function(e){i.sendEvents("Corporate benefits loading failed"),n.loading=!1,n.error=!0})},n.init(),n.onClickOfBenef=function(e){_.forEach(n.beneficiaries,function(t){t.selected=t.maid==e.maid}),n.selectedBenef=e,_.each(n.selectedBenef.packages,function(e){e.display=!0}),c(function(){b.refresh(!0)},0)},n.AddToCart=function(e,t,a){a&&a.stopPropagation(),e.patientId=t.maid,e.selected=!0;var r={};i.providerParams.providerSelected&&!k.providerChange||(r={providerId:n.providerDetails.providerId,providerSelected:!0});var o=i.labsCart();return i.providerParams.providerId!=n.providerDetails.providerId&&_.union(o.tests,o.packages).length>0?void m(e,r):(i.sendEvents("Add to cart",{providerFlow:!0,contractId:9716}),void i.addItemsToCart([e],"+",!1,!0,r))},n.DeleteToCart=function(e,t,a){a&&a.stopPropagation(),e.selected=!1,i.addItemsToCart([e],"-",!1,!0)},n.showPackageDetails=function(e,a){n.packagePipeline.show=!0,n.packagePipeline.packageId=e.packageId,n.packagePipeline.providerId=n.providerDetails.providerId,n.packagePipeline.isHomeSampleAvailable=e.isHomeSampleAvailable,n.packagePipeline.showFamilyPopUp=!1,n.packagePipeline.contractId=e.contractId||t.ahcContract,a?n.packagePipeline.patientId=a:(n.packagePipeline.patientId=null,n.packagePipeline.showFamilyPopUp=!0),_.isEmpty(n.packageEligiblitiy)||(n.packagePipeline.packageEligiblitiy=n.packageEligiblitiy)};var I=e.$on("cartItemsUpdated",function(t,a){n.mergeList=i.labsCart(),_.each(n.beneficiaries,function(e){_.isEmpty(e.packages)||_.each(e.packages,function(t){var i=a.cartItems&&a.cartItems.find(function(a){return a.packageId==t.packageId&&a.patientId==e.maid})||!1;i?(t.isPresentInCart=!0,t.cartId=i.cartId):(t.isPresentInCart=!1,t.cartId=0),t.isCartVisitType=t.isHomeSampleAvailable!=n.mergeList.isLabVisit})}),n.countMap=_.groupBy(a.cartItems,"packageId"),e.$broadcast("cartItemsCount",n.mergeList.tests.length+n.mergeList.packages.length),_.isEmpty(a.params)||!a.params.providerSelected||_.isEmpty(n.providerDetails)||(i.providerParams=n.providerDetails,i.providerParams.providerSelected=a.params.providerSelected,k.providerChange=!1),n.mergeList.empty&&(i.providerParams={}),n.hideSelected=!i.providerParams.providerSelected||i.providerParams.providerId!=n.providerDetails.providerId,d(),u()});n.$on("$destroy",function(e){I()})}}}]),e.register.directive("uploadAuthLetter",["$rootScope","authService","apiProvider","$uibModal","navConstantsSvc",function(e,t,a,i,n){return{restrict:"EA",scope:{},link:function(r){r.isMobileView=e.isMobileView,r.totalFiles=[],r.uploadedFiles=[];var o=t.getUserObj();r.disclaimer=o&&o.authLetterUploadInfo&&o.authLetterUploadInfo.authLetterUploadDiscription?o.authLetterUploadInfo.authLetterUploadDiscription:n.AuthLetterInfoObject.authLetterUploadDisclaimer,r.discription=o&&o.authLetterUploadInfo&&o.authLetterUploadInfo.authLetterUploadDisclaimer?o.authLetterUploadInfo.authLetterUploadDisclaimer:n.AuthLetterInfoObject.authLetterUploadDiscription,r.errFiles=[],r.step=0;var s=i.open({animation:!0,scope:r,backdrop:"static",keyboard:!0,templateUrl:"labtest/templates/uploadAuthLetter.html?"+timeStamp,controller:["$scope","$uibModalInstance",function(e,t){e.closePopUp=function(){t.dismiss("cancel")}}],size:e.isMobileView?"bottom":"border modal-md",windowClass:e.isMobileView&&"bottom-sheet"}).closed.then(function(){r.totalFiles=[],r.uploadedFiles=[]});r.togglePopup=function(){0===r.step&&(r.step=1)},r.removeFile=function(e){r.totalFiles.splice(e,1)},r.uploadFiles=function(e,t){if(e){String.prototype.includes||(String.prototype.includes=function(){return String.prototype.indexOf.apply(this,arguments)!==-1});for(var a=0;a<e.length;a++)if(e[a].name.indexOf("exe")>-1||e[a].name.indexOf("bat")>-1||e[a].size/1048576>5)t.push(e[a]),e.splice(a,1),a--;else{var i=_.where(r.totalFiles,{name:e[a].name});_.isEmpty(i)&&r.totalFiles.push(e[a])}r.files=e,t.length>0&&(r.errFiles=t)}},r.submitAuthLetter=function(){r.totalFiles.length>0&&(r.errFiles=[],t.uploadFile(r.totalFiles[0],n.ahcContract,n.FileType.Prescription).then(function(e){if(e.data.isSuccess){r.appBasedProfileData=JSON.parse(t.profileInfo.appBasedProfileData);var i=[],n={};n.authorizationLetterName=e.data.fileUploadedList[0],n.authorizationLetterUploadDate=new Date,i.push(n),r.appBasedProfileData.authLetterInfo=i;var s=a.apiUrl+"/UpdateProfile.json",c=t.profileInfo;c.profileDataJson=JSON.stringify(r.appBasedProfileData),t.makeAjaxCalls(s,c,"POST",o.token).then(function(e){e.data&&(r.step=2,t.profileInfo.appBasedProfileData=JSON.stringify(r.appBasedProfileData))})}}))},r.$on("$destroy",function(){r.step=0,s=null})}}}]),e.register.directive("uploadPrescription",["$rootScope","authService","apiProvider","$uibModal","$timeout","patternService","$state","corpLabsService",function(e,t,a,i,n,r,o,s){return{restrict:"EA",scope:{pipeline:"=",isAilmentRequired:"=?"},link:function(n){n.isMobileView=e.isMobileView,_.isEmpty(n.pipeline.eventProps)&&(n.pipeline.eventProps={}),s.sendEvents("Labs Upload RX clicked",_.extend(n.pipeline.eventProps,{orderId:parseInt(n.pipeline.orderId),AilmentRequired:n.isAilmentRequired}));var r=i.open({animation:!0,scope:n,backdrop:!0,keyboard:!0,templateUrl:"labtest/templates/uploadPrescription.html?"+timeStamp,controller:["$scope","$uibModalInstance",function(e,t){e.closePopUp=function(){t.dismiss("cancel")}}],size:e.isMobileView?"bottom":"border modal-md",windowClass:e.isMobileView&&"bottom-sheet"}).closed.then(function(){n.pipeline.show=!1,n.isAilmentRequired=!1});n.totalFiles=[],n.selectedAilment="",n.step=0;var o=t.getUserObj();n.ailmentLoaded=!1,n.isAilmentRequired&&t.makeAjaxCalls(a.apiUrl+"/Labs/v1/FetchAilments","","GET",o.token).then(function(e){
e.data&&!_.isEmpty(e.data.ailments)&&(n.ailments=e.data.ailments),n.ailmentLoaded=!0}),n.removeFile=function(e){n.totalFiles.splice(e,1)},n.ailmentChange=function(e){n.selectedAilment=e},n.submitRx=function(){n.selectedAilment&&s.sendEvents("Labs Ailment Selected",_.extend(n.pipeline.eventProps,{orderId:parseInt(n.pipeline.orderId),AilmentRequired:n.isAilmentRequired,ailment:n.selectedAilment})),t.makeAjaxCalls(a.apiUrl+"/Labs/v1/uploadRx",{orderId:parseInt(n.pipeline.orderId),orderIds:n.pipeline.orderIds||[],patientId:n.pipeline.patientId.toString(),ailment:n.selectedAilment?n.selectedAilment:null,prescriptions:n.totalFiles.map(function(e){return{fileName:e.fileName,fileIdentifier:e.filePublicUrl}})},"POST",o.token).then(function(e){e.data&&e.data.isSuccess&&(n.step=1,n.$emit("prescriptionUploaded",{uploaded:!0}),s.sendEvents("Labs Upload RX Success",_.extend(n.pipeline.eventProps,{orderId:parseInt(n.pipeline.orderId),AilmentRequired:n.isAilmentRequired,ailment:n.selectedAilment?n.selectedAilment:null})))})},n.uploadFiles=function(e,a){if(e){String.prototype.includes||(String.prototype.includes=function(){return String.prototype.indexOf.apply(this,arguments)!==-1});for(var i=0;i<e.length;i++){var r=e[i];t.uploadFile(r,10389,"Prescription").then(function(e){e.data&&e.data.isSuccess&&n.totalFiles.push(e.data.fileDetails[0])})}}},n.$on("$destroy",function(){n.pipeline={},n.step=0,r=null})}}}]),e.register.directive("walletCoverageNotes",["$rootScope","navConstantsSvc","authService","$state","apiProvider","$httpParamSerializer","$stateParams","$timeout","notify","$location","corpLabsService",function(e,t,a,i,n,r,o,s,c,l,d){return{restrict:"AE",scope:{ailmentsNotCovered:"=?",pleaseNoteWalletCoverage:"=?"},terminal:!0,priority:1e6,templateUrl:"labtest/templates/walletCoverageNotes.html?"+timeStamp,link:function(t){function i(){d.fetchCorporateAilments().then(function(e){t.ailmentsNotCovered=e})}var n=a.isUserSignedin();t.isMobileView=e.isMobileView,d.sendEvents("Labs Know More clicked",{RxRequired:!0,VisitType:d.labsCart().isLabVisit?"LV":"HV"}),t.ailmentsNotCovered=[],t.pleaseNoteWalletCoverage=n.walletCoverageNotes,t.closePopUp=function(){t.$parent&&t.$parent.$parent&&t.$parent.$parent.$dismiss&&(window.sessionStorage.setItem("opened_wallet_coverage_popup",!0),t.$parent.$parent.$dismiss("cancel"))},i()}}}])})}();