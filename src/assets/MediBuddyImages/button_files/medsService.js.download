!function(){"use strict";define(["angular","utility"],function(e,t){var a=e.module("marketplace.MedsService",[]);a.factory("medsService",["navConstantsSvc","apiProvider","$sce","authService","$state","localStorageService","$rootScope","$http","notify","Upload","$timeout","$uibModal","$window",function(e,a,n,s,r,i,o,c,d,u,m,l,p){var f=(i.get("medsPrescription")||[],{patient_name:"NA"}),g=function(e){i.set("medsCartId",e)},v=function(){return i.get("medsCartId")||null},h=function(){i.remove("medsCartId")},b=function(){i.remove("medsPatientId")},y=function(){var e=s.removeMedsLocalCart();return o.$broadcast("medsCartItemsCount",0),h(),b(),e},I=function(){localStorage.removeItem("medsPrescriptionsWithName"),localStorage.removeItem("medsPrescriptions")},C=function(e,t,n){var r=a.medsService+"app/cart/item/"+t,u=s.isUserSignedin();return new Promise(function(a,m){if(u){var l={device:"WEB",version:"10",appversion:"v3.2.19_dev",email:u.userDetails.email,gcm:"eSxv53P7QbeVN8CtdJFfuX:APA91bFHr6jF2byPipuQiGTczmLLGjYU8iRNMF1u-duxPlBsvjsBRN24LhveJWG_mheAGLwXs67tThyNNkWEapxxon-Cn2JmJW7Q3yXt44ir3qfqQH1iIsX_yPAuA9DWY16_uJ685ats",platform:"WEB",domain:"Patient",appsFlyerUID:"",phonenumber:u.userDetails.phone,name:u.userDetails.username,timezone:"Asia/Kolkata",language:"English"};W(l).then(function(t){return c.post(r,{masterDrugCode:e,patientId:t,prePaymentCartId:v(),pincode:parseInt(s.getPincode())},{headers:{"content-type":"application/json; charset=UTF-8",source:"web",platform:"WEB",mbservertoken:u.encryptedToken}}).then(function(e){return n.count=e.data.message.itemQuantity,e.data.error?e.data.error:(i.set("medsCart",e.data.message.cart.items),g(e.data.message.prePaymentCartId),o.$broadcast("medsCartItemsCount",e.data.message.cart.totalItems),o.notification=e.data.message.notification,o.notification&&o.notification.tobeShown&&d({message:o.notification.message,position:"center",duration:5e3}),void a(e.data.message))})["catch"](function(e){return e})})}else{var p={};p.cart={};var f=i.get("medsCart"),h=f.findIndex(function(e){return n.drugCode==e.drugCode});"add"==t?h>-1?(f[h].count+=1,n.count=f[h].count):(n.count+=1,f.push({drugCode:e,count:1}),h=f.findIndex(function(t){return e==t.drugCode})):"remove"==t&&h>-1&&(f[h].count<=1?(f.splice(h,1),n.count=0):(f[h].count-=1,n.count=f[h].count)),p.cart.items=f,p.masterDrugCode=e,p.itemQuantity=n.count||0,p.totalItems=f.reduce(function(e,t){return e+t.count},0),p.noOfDistintItems=f.length,i.set("medsCart",f),o.$broadcast("medsCartItemsCount",p.totalItems),a(p)}})},k=function(e,t){var n=s.isUserSignedin();return new Promise(function(r,d){if(n){var u={device:"WEB",version:"10",appversion:"v3.2.19_dev",email:n.userDetails.email,gcm:"eSxv53P7QbeVN8CtdJFfuX:APA91bFHr6jF2byPipuQiGTczmLLGjYU8iRNMF1u-duxPlBsvjsBRN24LhveJWG_mheAGLwXs67tThyNNkWEapxxon-Cn2JmJW7Q3yXt44ir3qfqQH1iIsX_yPAuA9DWY16_uJ685ats",platform:"WEB",domain:"Patient",appsFlyerUID:"",phonenumber:n.userDetails.phone,name:n.userDetails.username,timezone:"Asia/Kolkata",language:"English"};W(u).then(function(d){return c.post(a.apiUrl+"meds/cart/add",{cartItems:[{itemId:e,source:t,platform:"web",patientId:d,quantity:1}],pincode:parseInt(s.getPincode())},{headers:{"content-type":"application/json; charset=UTF-8",accesstoken:n.token}}).then(function(e){i.set("medsCart",e.data.cart.cartItems),o.$broadcast("medsCartItemsCount",e.data.cart.length),r(e.data)})})}else{var m=i.get("offlineMedsCartV2");m||(m=[]);const l=m.map(function(e){return e.itemId});l.includes(e)||m.push({itemId:e,quantity:1}),i.set("offlineMedsCartV2",m),r({cart:{cartItems:m}})}})},P=function(){var e=i.get("offlineMedsCartV2"),t=s.isUserSignedin();return new Promise(function(n,r){if(t){var d={device:"WEB",version:"10",appversion:"v3.2.19_dev",email:t.userDetails.email,gcm:"eSxv53P7QbeVN8CtdJFfuX:APA91bFHr6jF2byPipuQiGTczmLLGjYU8iRNMF1u-duxPlBsvjsBRN24LhveJWG_mheAGLwXs67tThyNNkWEapxxon-Cn2JmJW7Q3yXt44ir3qfqQH1iIsX_yPAuA9DWY16_uJ685ats",platform:"WEB",domain:"Patient",appsFlyerUID:"",phonenumber:t.userDetails.phone,name:t.userDetails.username,timezone:"Asia/Kolkata",language:"English"};W(d).then(function(r){var d=[];return _.forEach(e,function(e){d.push({itemId:e.itemId,source:"web login Bulk",platform:"web",patientId:r,quantity:e.quantity})}),c.post(a.apiUrl+"meds/cart/add",{cartItems:d,pincode:parseInt(s.getPincode())},{headers:{"content-type":"application/json; charset=UTF-8",accesstoken:t.token}}).then(function(e){i.set("medsCart",e.data.cart.cartItems),i.set("offlineMedsCartV2",[]),o.$broadcast("medsCartItemsCount",e.data.cart.length),n(e.data)})})}else{var u=i.get("offlineMedsCartV2");u||(u=[]);const m=u.map(function(e){return e.itemId});m.includes(masterDrugCode)||u.push({itemId:masterDrugCode,quantity:1}),i.set("offlineMedsCartV2",u),n({cart:{cartItems:u}})}})},D=function(e,t,n){var r=s.isUserSignedin();if(!r){var o=i.get("offlineMedsCartV2");o||(o=[]);var d=o.findIndex(function(e){return e.itemId==n});return o[d].quantity=t,i.set("offlineMedsCartV2",o),new Promise(function(e){e({cart:{cartItems:o}})})}return new Promise(function(n,s){return c.post(a.apiUrl+"meds/cart/quantity",{cartItems:[{cartItemId:e,quantity:t}]},{headers:{accesstoken:r.token}}).then(function(e){i.set("medsCart",e.data),n(e.data)})})},w=function(e,t){var n=s.isUserSignedin();if(!n){var r=i.get("offlineMedsCartV2");r||(r=[]);var d=r.findIndex(function(e){return e.itemId==t});return r.splice(d,1),i.set("offlineMedsCartV2",r),new Promise(function(e){e({cart:{cartItems:r}})})}return new Promise(function(t,s){return c.post(a.apiUrl+"meds/cart/remove",{cartItems:[{cartItemId:e,removeCartItem:!0}]},{headers:{accesstoken:n.token}}).then(function(e){i.set("medsCart",e.data),o.$broadcast("medsCartItemsCount",e.data.cart?e.data.cart.cartItems.length:0),t(e.data)})})},U=function(){var e=s.isUserSignedin();return new Promise(function(t,n){return c.post(a.apiUrl+"meds/cart/remove",{removeCart:!0},{headers:{accesstoken:e.token}}).then(function(e){if(e.data.success){var a=s.removeMedsLocalCart();return o.$broadcast("medsCartItemsCount",0),h(),b(),void t(a)}throw new Error("Remove cart failed")})})},S=function(){var e=a.apiUrl+"meds/cart/fetch",t=s.isUserSignedin();return new Promise(function(a,n){if(t)return c.post(e,{},{headers:{accessToken:t.token}}).then(function(e){i.set("medsCart",e.data),i.set("medCart",e.data),o.$broadcast("medsCartItemsCount",e.data.cart?e.data.cart.cartItems.length:0),a(e.data)})["catch"](function(e){});var s=i.get("offlineMedsCartV2");s||(s=[]);var r=s.reduce(function(e,t){return e+t.count},0);o.$broadcast("medsCartItemsCount",r),a({cart:{cartItems:s}})})},T=function(e){var t=s.isUserSignedin();return t?new Promise(function(n,s){return c.post(a.apiUrl+"meds/cart/updateMeta",{updatePincode:e},{headers:{accesstoken:t.token}}).then(function(e){n(e.data)})}):new Promise(function(e){e(!1)})},M=function(e){var t=F(),a=0;return t&&0!=t.length||e.forEach(function(e){e.count=0}),_.forEach(t,function(t){var n=e.findIndex(function(e){return e.drugCode==t.drugCode});n!=-1&&(e[n].count=t.count||t.addedQuantity),a=t.count||t.addedQuantity||t.length||0}),{meds:e,cartQuantity:a}},A=function(e,t,a){e.findIndex(function(e){return t==e.drugCode});return o.$apply(),e},N=function(){if(h(),b(),i.get("medsCartId"))y(),d({message:"Unfortunately we couldn't fetch your cart items. Kindly add items again to proceed",position:"center",duration:5e3}),r.go("app.medicine",{categoryItemTypeId:"Medicine"});else{var e=i.get("medsCart");if(e&&e.length>0){const t=e.map(function(e){var t=e.drugCode,a=e.count,n=e.addedQuantity;return{quantity:a||n,drugCode:t}});var n=s.isUserSignedin(),o=a.medsService+"app/cart/addItemBulk";return new Promise(function(e,a){W({device:"WEB",version:"10",appversion:"v3.2.19_dev",email:n.userDetails.email,gcm:"eSxv53P7QbeVN8CtdJFfuX:APA91bFHr6jF2byPipuQiGTczmLLGjYU8iRNMF1u-duxPlBsvjsBRN24LhveJWG_mheAGLwXs67tThyNNkWEapxxon-Cn2JmJW7Q3yXt44ir3qfqQH1iIsX_yPAuA9DWY16_uJ685ats",platform:"WEB",domain:"Patient",appsFlyerUID:"",phonenumber:n.userDetails.phone,name:n.userDetails.displayName,timezone:"Asia/Kolkata",language:"English"}).then(function(a){s.getuserLongToken(n.token).then(function(s){c.post(o,{drugCodes:t,patientId:a,pincode:560076},{headers:{"content-type":"application/json; charset=UTF-8",source:"web",mbservertoken:n.encryptedToken||s.data.encryptedToken}}).then(function(t){i.set("medsCart",t.data.message.items),g(t.data.message.prePaymentCartId),e(t.data.message)})["catch"](function(t){e(t)})})})})}}},F=function(){const e=i.get("medsCartId");var t=a.medsService+"app/cart/"+e+"?pincode="+s.getPincode(),n=s.isUserSignedin();return new Promise(function(a,s){if(n&&e)return c.get(t,{headers:{"content-type":"application/json; charset=UTF-8",source:"web",mbservertoken:n.encryptedToken}}).then(function(e){i.set("medCart",e.data.message.items),o.$broadcast("medsCartItemsCount",e.data.message.totalItems),o.notification=e.data.message.notification,o.notification&&o.notification.tobeShown&&d({message:o.notification.message,position:"center",duration:5e3}),a(e.data.message)})["catch"](function(e){});var r=i.get("medsCart"),u={};u.items=r,u.totalItems=r.reduce(function(e,t){return e+t.count},0),u.noOfDistintItems=r.length,o.$broadcast("medsCartItemsCount",u.totalItems),a(u)})},E=function(e){var t=JSON.parse(JSON.stringify(e.searchData));"UPLOADRX"==e.searchData.additionalParams.meta.type&&1!=e.isReOrder&&g(0);var a=v(),n={addressCity:s.getCity(),addressLine:t.addressLine1+", "+t.addressLine2,deliveryType:e.storeData?"store_pickup":"home_delivery",email:t.email,paymentTypeId:e.checkoutData&&e.checkoutData.paymentTypeId?e.checkoutData.paymentTypeId:0,gender:"M"===t.gender?"Male":"Female",isRxUpload:"UPLOADRX"==e.searchData.additionalParams.meta.type||"REORDER"==e.searchData.additionalParams.meta.type,maid:e.appointmentData&&e.appointmentData.maid?String(e.appointmentData.maid):"0",meta:t.additionalParams.meta,packageName:t.packageName,patientDetails:{firstName:t.patientName.split(" ")[0],lastName:t.patientName.split(" ").length>1?t.patientName.substring(t.patientName.indexOf(" ")+1):""},walletName:e.walletType?e.walletType:null,bookingSource:"web",patientId:i.get("patientId"),paymentMode:"COD",couponCode:e.couponCode,phoneNumber:t.phone,pickupStoreID:e.storeData.storeID,pincode:t.pincode.toString(),prePaymentCartId:a?a:0,prescriptionFilePaths:[],relation:t.relation,retainCoupon:!1,storeAddress:e.storeData.address,uploadedFiles:t.uploadedFiles,ailment:t.ailment||"",uploadRxInstruction:e.resData.remark};return e.checkoutData=n,i.set("checkoutData",e.checkoutData),n},W=function(e){var t=i.get("medsPatientId"),n=a.medsService+"app/authenticate/medibuddyUser",r=s.isUserSignedin();return new Promise(function(a,o){t?a(t):s.getuserLongToken(r.token).then(function(t){c.post(n,e,{headers:{advertiserid:"898503d6-9c78-4248-b915-52e2bf527385","content-type":"application/json",mbappversioncode:"509",mbappversionname:"3.2.19_dev",mbservertoken:r.encryptedToken||t.data.encryptedToken,newrelic:"{v:[0,2],d:{d.ty:Mobile,d.ac:,d.ap:,d.tr:2b7cb8f24ec3474e88b796c2c1f5cdb4,d.id:fee4dbe33c414009,d.ti:1662553963298}}",source:"AndroidMB",traceparent:"00-2b7cb8f24ec3474e88b796c2c1f5cdb4-fee4dbe33c414009-00",tracestate:"@nr=0-2---fee4dbe33c414009----1662553963298",type:"search"}}).then(function(e){i.set("medsPatientId",e.data.message.patientId),a(e.data.message.patientId)})["catch"](function(e){return e})})})},x=function(e){var t=a.apiUrl+"meds/checkout",n=s.isUserSignedin();return new Promise(function(a,s){if(n){var r={device:"WEB",version:"10",appversion:"v3.2.19_dev",email:n.userDetails.email,gcm:"eSxv53P7QbeVN8CtdJFfuX:APA91bFHr6jF2byPipuQiGTczmLLGjYU8iRNMF1u-duxPlBsvjsBRN24LhveJWG_mheAGLwXs67tThyNNkWEapxxon-Cn2JmJW7Q3yXt44ir3qfqQH1iIsX_yPAuA9DWY16_uJ685ats",platform:"WEB",domain:"Patient",appsFlyerUID:"",phonenumber:n.userDetails.phone,name:n.userDetails.username,timezone:"Asia/Kolkata",language:"English"};W(r).then(function(s){return e.patientId=s,c.post(t,e,{headers:{advertiserid:"137a501d-ee2d-4b9c-a6a6-4ca2d6e04cbb","content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",accessToken:n.token,useraccesstoken:""}}).then(function(e){e.data.errMessage&&a(e.data),o.notification=e.data.message.notification,o.notification&&o.notification.tobeShown&&(o.modalInstance=l.open({animation:!0,backdrop:"none",template:'<div class="modal-bottom-header modal-header p-t-10 p-l-20 p-r-20 primary-color"><div class="btn-border-close m-b-20"><span class="cursor-pointer pull-right" ng-style="{\'color\':isHover ? \'#000\' : \'#aaa\'}" ng-class="{\'md-dark-color\':isMobileView}"ng-init="isHover=false;" ng-mouseover="isHover=true;" ng-mouseout="isHover=false;" ng-click="closeModal()">close</span></div></div><div class="modal-body primary-color modal-border-body clearfix" ng-class="{\'p-t-0\':!isMobileView}"><div class="col-xs-12 col-md-12 p-l-0 p-r-0"><div class="m-b-5"><b>{{centerVisitTest}}</b> <br>'+"<p ng-if=\"unavailableItems.length>0\" ng-style=\"{'color':'#79AB28','text-decoration': 'underline', 'text-decoration-style': 'dotted'}\">{{unavailable}}</p><ul><li ng-repeat=\"item in unavailableItems\">{{item.name}} </li></ul><p ng-if=\"availableItems.length>0\"  ng-style=\"{'color':'#79AB28','text-decoration': 'underline', 'text-decoration-style': 'dotted' }\">{{available}}</p><ul><li ng-repeat=\"item in availableItems\">{{item.name}} </li></ul></div><button class=\"br-15 btn btn-primary btn-block p-t-10 p-b-10 m-t-20\" ng-click=\"apply()\">Proceed for Payment</button></div></div>",scope:o,controller:["$scope","$uibModalInstance",function(t,a){t.centerVisitTest=o.notification.message,t.cart=e.data.message.cartItems,t.availableItems=t.cart.filter(function(e){return"available"==e.availability.toLowerCase()}),t.unavailableItems=t.cart.filter(function(e){return"available"!=e.availability.toLowerCase()}),t.available="Available Items ("+scope.availableItems.length+")*",t.unavailable="Unavailable Items ("+scope.unavailableItems.length+")*",t.closeModal=function(){a.dismiss("cancel")},t.apply=function(){console.log("Broadcasting medsPaymentMethod"),o.$emit("medsPaymentMethod"),t.closeModal()},t["continue"]=function(){t.closeModal()}}],size:o.isMobileView?"bottom":"border modal-sm",windowClass:o.isMobileView&&"bottom-sheet"})),a(e.data.message)})["catch"](function(e){a("")})})}})},L=function(e,t){var n=a.medsService+"app/cart/removeCoupon",r=s.isUserSignedin(),i=E(t);return i.bookingSource="web",e=Object.assign(e,{walletRequest:i}),new Promise(function(a,s){c.post(n,e,{headers:{advertiserid:"137a501d-ee2d-4b9c-a6a6-4ca2d6e04cbb","content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",mbservertoken:r.encryptedToken,useraccesstoken:"",accessToken:t.mbtoken}}).then(function(e){a(e.data.message)})})},B=function(e,t){var n=a.medsService+"app/cart/changeWallet",r=s.isUserSignedin(),i=E(t);return i.bookingSource="web",e=Object.assign(e,{walletRequest:i}),new Promise(function(t,a){c.post(n,e,{headers:{advertiserid:"137a501d-ee2d-4b9c-a6a6-4ca2d6e04cbb","content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",mbservertoken:r.encryptedToken,useraccesstoken:""}}).then(function(e){t(e.data.message)})["catch"](function(e){console.error("catch -> changeWallet",e.data.errMessage,e.data.errMessage.stack),t("")})})},J=function(e,t){var n=a.medsService+"app/cart/addCoupon",r=s.isUserSignedin(),i=E(t);return i.bookingSource="web",e=Object.assign(e,{walletRequest:i}),new Promise(function(a,s){c.post(n,e,{headers:{advertiserid:"137a501d-ee2d-4b9c-a6a6-4ca2d6e04cbb","content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",mbservertoken:r.encryptedToken,useraccesstoken:"",accessToken:t.checkoutResponseData&&t.checkoutResponseData.checkoutResponse&&t.checkoutResponseData.checkoutResponse.accessToken?t.checkoutResponseData.checkoutResponse.accessToken:t.mbtoken}}).then(function(e){e.data.error&&a(e.data),a(e.data.message)})})},j=function(e,t){var n=a.apiUrl+"meds/bookOrder",r=s.isUserSignedin();return new Promise(function(e,t){c.get(n,{headers:{advertiserid:"137a501d-ee2d-4b9c-a6a6-4ca2d6e04cbb","content-type":"application/json; charset=UTF-8",source:"web",version:"1.2.3",platform:"web",useraccesstoken:"",newCheckout:!0,accessToken:r.token}}).then(function(t){t.errorMessage?(console.log(t.errorMessage),e(t.errorMessage)):e(t.data)})})},R=function(t,n,i,o){return U().then(function(u){I();var m=a.apiUrl+"meds/reorder/"+t,l=s.isUserSignedin();return new Promise(function(t,a){var u={device:"WEB",version:"10",appversion:"v3.2.19_dev",email:l.userDetails.email,gcm:"eSxv53P7QbeVN8CtdJFfuX:APA91bFHr6jF2byPipuQiGTczmLLGjYU8iRNMF1u-duxPlBsvjsBRN24LhveJWG_mheAGLwXs67tThyNNkWEapxxon-Cn2JmJW7Q3yXt44ir3qfqQH1iIsX_yPAuA9DWY16_uJ685ats",platform:"WEB",domain:"Patient",appsFlyerUID:"",phonenumber:l.userDetails.phone,name:l.userDetails.username,timezone:"Asia/Kolkata",language:"English"};W(u).then(function(a){var u={pincode:parseInt(n),patientId:parseInt(a),source:"Meds Home Page",platform:"Web"};return c.post(m,u,{headers:{"content-type":"application/json; charset=UTF-8",accessToken:l.token}}).then(function(a){if(a.data.errorMessage)d({message:a.data.message.error,position:"center",duration:5e3}),console.log(a.data.errorMessage),t(a.data.errorMessage);else{if(a.data.fileUploadedList.length>=0){var c={sessionData:{},forceUpdate:!0};s.medsReoderFiles=a.data.fileUploadedList;var u={fileArrays:JSON.stringify(a.data.fileUploadedList)};c.sessionData[e.medicineId]=JSON.stringify(u),a.data.medsCart.cart.cartItems.length>0?(p._MB_Analytics.__push({isCleverTap:!0,isGoogle:!1,name:"DigitisedCart",payload:p._Site_Props.__getEventParameters({service:!0,custom:{}})}),r.go("app.medicineCart",{medicine:"Medicines",pincode:n,reorder:!0},{reload:"app.medicineCart"})):o||(p._MB_Analytics.__push({isCleverTap:!0,isGoogle:!1,name:"NonDigitisedCart",payload:p._Site_Props.__getEventParameters({service:!0,custom:{}})}),r.go("app.medicine",{city:i,pincode:n},{reload:"app.medicine"}))}t(a.data)}})["catch"](function(e){console.log(e)})})})})};const Q=function(e,a,n){try{if(!e)return;this.standardEventsPayload["mb-s-sessionId"]||(this.standardEventsPayload["mb-s-sessionId"]=t.getMBSessionId());const r=s.isUserSignedin();if(r&&r.userDetails&&(this.standardEventsPayload.mbuserid=r.userDetails.userId.toString(),r.userDetails.uuid&&(this.standardEventsPayload.mbuuid=r.userDetails.uuid.toString()),this.standardEventsPayload.pmentityid=r.userDetails.pmEntityID.toString()),!this.standardEventsPayload.medsbookingtype){const o=i.get("utm_appname");this.standardEventsPayload.medsbookingtype="retailutility"==o?"Self Serve":"Assist"}const c=_.extend({},this.standardEventsPayload,a);p._MB_Analytics.__push({name:e.name,schema:e.schema,payload:c})}catch(d){}};return{reorder:R,updateItemOfCart:C,addBulkItemToCart:N,removeCartId:h,removeMedsCart:y,getCart:F,getCartV2:S,AddItemsBulkToCartV2:P,AddItemsToCartV2:k,changeCartQuantity:D,removeCartItem:w,changePincodeCart:T,getCartId:v,updateUiOnReload:M,updateUi:A,checkoutData:E,getPatientId:W,checkout:x,removeCouponV2:L,changeWallet:B,addCoupon:J,payment:j,updateCartId:g,removePrescription:I,removePatientId:b,sendGTMEvents:Q,standardEventsPayload:f}}])})}();