!function(){"use strict";define(["angular","utility"],function(e,a){var r=e.module("marketplace.CorpWellnessService",[]);r.factory("corpWellnessService",["$state","navConstantsSvc","apiProvider","localStorageService","authService","$rootScope","$http",function(r,t,i,o,s,n,c){function p(e){return _.filter(e,function(e){return e.minAge&&(e.minAge=parseInt(e.minAge)),e.maxAge&&(e.maxAge=parseInt(e.maxAge)),e=d(e),e.isCovid=e.packageName.toLowerCase().indexOf("covid")>-1,!(e.packageName.toLowerCase().indexOf("wellness coach")>-1)||(u.push(e.packageId),!1)})}function d(e){return"M"==e.gender||"Male"==e.gender?(e.iconUrl="/assets/icons/male-user",e.genderType="M"):"F"==e.gender||"Female"==e.gender?(e.iconUrl="/assets/icons/female-user",e.genderType="F"):e.iconUrl="/assets/icons/profile",e.labtests=[],e.consultations=[],_.each(e.investigations,function(a){"Consultation"==a.groupName||"Core_Consultation"==a.typeName?e.consultations.push(a):("Others"!=a.groupName||e.covidTest||(e.covidTest=_.contains(t.covidPackageList,a.name)),"Core_Profile"!=a.typeName&&e.labtests.push(a))}),e}var l=[],g=t.topCities;Date.prototype.addDays=function(e){return this.setDate(this.getDate()+parseInt(e)),this};var u=[],k=function(r,o){var d=new Promise(function(d,l){var g=s.isUserSignedin()||{},k={};s.makeAjaxCalls(i.apiUrl+"/AHC/GetPackagesForCorporate",r,"POST",g.token,"",o).then(function(r){if(r.data.isSuccess){var o=s.isUserSignedin();if(o&&o.corpConfig){k.corpConfig=o.corpConfig,n.corpConfig=_.pick(k.corpConfig,"suggestLabtest");var P=k.corpConfig.corporateLogo;!P&&g&&g.userDetails&&(P="/static/corpLogo/"+g.userDetails.pmEntityID+".png"),P&&c.get(i.staticUrl.slice(0,-1)+P.slice(7,P.length),{responseType:"blob"}).then(function(e){var a=new FileReader;a.readAsDataURL(e.data),a.onload=function(e){n.corpConfig.corporateLogo=e.target.result}})}r.data.serverDate&&(s.serverDate=parseInt(r.data.serverDate.replace("/Date(","")));var f=p(r.data.ahcPackages),v=_.groupBy(f,"packageId");k.ahcPackages=r.data.ahcPackages,k.employeeDetail=r.data.employeeDetail,k.pmEntityID=r.data.pmEntityId,k.accessToken=r.data.accessToken,k.isSponseredBook=r.data.isSponseredBook,_.each(k.employeeDetail.beneficiaries,function(t){_.isEmpty(u)||(t.sponsPackage=_.reject(t.sponsPackage,function(e){return _.contains(u,e)}),t.paidPackage=_.reject(t.paidPackage,function(e){return _.contains(u,e)})),t.genderFilter={type:t.gender,isTrue:!0},t.maxAge=t.age,t.minAge=0;var i=e.copy(t);if(!_.isEmpty(t.sponsPackage)){i.isSponsored=!0,i.price=0,t.sponsPackageIds=t.sponsPackage;var o=e.copy(v);t.sponsPackage=_.map(t.sponsPackage,function(e){return o[e]?(a.getFlatProperty(k,"configuration.displaySponsoredPrice")||(o[e][0].price=0),_.omit(_.extend(i,o[e][0]),"paidPackage","sponsPackage")):null})}if(t.sponsPackage=_.filter(t.sponsPackage,function(e){return e}),r.data.packagePriceDetail&&(s.corporatePackages.corporatePricing=_.groupBy(r.data.packagePriceDetail,"maid")),!_.isEmpty(t.paidPackage)){var n=s.corporatePackages.corporatePricing?s.corporatePackages.corporatePricing[t.maid]:[];i.isSponsored=!1,t.paidPackageIds=t.paidPackage,t.paidPackage=_.map(t.paidPackage,function(e){if(v[e]){if(n[0]&&!_.isEmpty(n[0].packagePrice)){var a=n[0].packagePrice.find(function(a){return a.packageId===e});a&&(v[e][0].price=a.price)}return _.omit(_.extend(i,_.omit(v[e][0],"minAge","maxAge")),"paidPackage","sponsPackage")}return null}),t.paidPackage=_.filter(t.paidPackage,function(e){return e})}"self"==t.relationName.toLowerCase()&&(k.primaryPackage=t)}),k.sponsoredPackages=_.flatten(_.compact(_.pluck(k.employeeDetail.beneficiaries,"sponsPackage"))),k.paidPackages=_.flatten(_.compact(_.pluck(k.employeeDetail.beneficiaries,"paidPackage"))),k.packageIds=_.pluck(f,"packageId"),_.forEach(k.sponsoredPackages,function(e){_.isUndefined(e.relationId)&&(e.relationId="Self"==e.relationName?0:1)}),s.corporatePackages.homeVisitPackages=[],s.corporatePackages.centerVisitPackages=[],k.packageIds=[],_.forEach(f,function(e){k.packageIds.push(e.packageId),e.isHomeSampleOnlyPackage?s.corporatePackages.homeVisitPackages.push(e):s.corporatePackages.centerVisitPackages.push(e)}),s.corporatePackages.paidPackages=k.paidPackages,s.corporatePackages.ahcPackages=f,k.sponsoredPackages=_.sortBy(k.sponsoredPackages,"relationId"),s.corporatePackages.sponsoredPackages=_.sortBy(k.sponsoredPackages,function(e){return!e.isHomeSampleOnlyPackage}),s.corporatePackages.employeeDetail=k.employeeDetail,d(k),window._Site_Props.__setServiceDetails({serviceName:t.ahcFilterName,serviceType:"UCP"})}else{var m=new Error(r.data.errorMessage);l(m)}},function(e){e.message="It is taking longer than usual, please reload the page or try again later.",l(e)})});return d},P=function(e,r){var t=new Promise(function(t,o){var n={},c=s.isUserSignedin();s.makeAjaxCalls(i.apiUrl+"/AddBeneficiary",e,"POST",c.token,"",r).then(function(r){if(r.data.isSuccess&&r.data.vasBenefId)if(_.isEmpty(r.data.ahcPackages))n.noMatch=!0,t(n);else{var i=p(r.data.ahcPackages),c=_.isEmpty(r.data.packagePriceDetail)?[]:r.data.packagePriceDetail[0].packagePrice;if(1===i.length){var d=a.calculateAge(e.dob,s.serverDate),l={maid:r.data.vasBenefId,relationName:e.relationName,isSponsored:!1,gender:e.gender,name:e.name,age:d,genderFilter:{isTrue:!0,type:e.gender},maxAge:d,minAge:0,iconUrl:"M"==e.genderType?"/assets/icons/male-user":"/assets/icons/female-user",showAddon:!1,showDetails:!1,isAddedToCart:!1},g=c.find(function(e){return e.packageId==i[0].packageId});g&&(i[0].price=g.price),n.packageAdded=Object.assign(l,i[0]),s.corporatePackages.paidPackages.unshift(n.packageAdded)}else i.forEach(function(t){var i=a.calculateAge(e.dob,s.serverDate),o={maid:r.data.vasBenefId,relationName:e.relationName,isSponsored:!1,gender:e.gender,name:e.name,age:i,genderFilter:{isTrue:!0,type:e.gender},maxAge:i,minAge:0,iconUrl:"M"==e.genderType?"/assets/icons/male-user":"/assets/icons/female-user",showAddon:!1,showDetails:!1,isAddedToCart:!1},n=c.find(function(e){return e.packageId==t.packageId});n&&(t.price=n.price);var p=Object.assign(o,t);s.corporatePackages.paidPackages.unshift(p)});n.maidAdded=r.data.vasBenefId,t(n)}else o({errorMessage:r.errorMessage})},function(e){o()})});return t},f=function(e,a,r){var t=s.isUserSignedin(),o=30,n=s.corporatePackages.providers.map(function(e){return e.dcId?parseInt(e.dcId):0}),c={ContractId:9716,ProviderIds:[],NoOfDays:o,pmEntityId:t.userDetails.pmEntityID,IsHomeVisitCase:!0,packageIds:[e.packageId],pincode:parseInt(a)},p=new Promise(function(a,t){var o={};s.makeAjaxCalls(i.apiUrl+"/AHC/ProvidersWithCalendar",c,"POST").then(function(t){console.log(t),t.data.slotDetails&&(s.serverDate=parseInt(t.data.slotDetails.serverDate.replace("/Date(","")));var i=[],c=new Object;c.providerId=r,_.forEach(t.data.unionOfSlots,function(e,a){t.data.unionOfSlots[a].providerId=r}),c.daySlots=t.data.unionOfSlots,i.push(c),console.log(i),e.providerSlots=i,e.availableSlots=t.data.slotDetails.availableCalendarDays,s.corporatePackages.packageDetail=e;var p=_.pluck(t.data.slotDetails.providerSlots,"providerId");o.providers=_.filter(s.corporatePackages.providers,function(e){return e.isAutoSlotAvailable=_.contains(p,parseInt(e.dcId)),e.noAutoSlotAvailable=e.isAutoSlotAvailable?0:1,_.contains(n,parseInt(e.dcId))}),_.isEmpty(s.corporatePackages.blockDates)||_.each(e.providerSlots,function(e){s.corporatePackages.blockDates[e.providerId]&&_.each(s.corporatePackages.blockDates[e.providerId],function(a){var r=_.find(e.slots,function(e){return e.date==a.blockDate});r&&(r.availableSlots=0)})}),a(o)},function(e){t()})});return p},v=function(e){var a=s.isUserSignedin(),r=s.corporatePackages.providers.filter(function(e){return e.dcCity==s.getCity()}).map(function(e){return e.dcId?parseInt(e.dcId):0}),o={ProviderIds:_.uniq(r),pmEntityId:a.userDetails.pmEntityID,NoOfDays:30,ContractId:t.ahcContract,IsHomeVisitCase:e.isHomeSampleOnlyPackage,packageIds:s.corporatePackages.packageDetail?[s.corporatePackages.packageDetail.packageId]:[]},n=new Promise(function(a,r){var t={};s.makeAjaxCalls(i.apiUrl+"Labs/ProvidersCalendar",o,"POST").then(function(r){r.data.serverDate&&(s.serverDate=parseInt(r.data.serverDate.replace("/Date(",""))),e.providerSlots=r.data.providerSlots,e.availableSlots=r.data.availableCalendarDays,s.corporatePackages.packageDetail=e;var i=_.pluck(r.data.providerSlots,"providerId");t.providers=_.filter(s.corporatePackages.providers,function(e){return e.isAutoSlotAvailable=_.contains(i,parseInt(e.dcId)),e.noAutoSlotAvailable=e.isAutoSlotAvailable?0:1,_.contains(o.ProviderIds,parseInt(e.dcId))}),_.isEmpty(s.corporatePackages.blockDates)||_.each(e.providerSlots,function(e){s.corporatePackages.blockDates[e.providerId]&&_.each(s.corporatePackages.blockDates[e.providerId],function(a){var r=_.find(e.slots,function(e){return e.date==a.blockDate});r&&(r.availableSlots=0)})}),a(t)},function(e){r()})});return n},m=function(e,a){var r=s.isUserSignedin(),t=new Promise(function(t,o){var n={};_.each(e.beneficiaries,function(e){a.ahcBookingeDetails.push({maid:e.maid,PackageIds:e.paidPackageIds||e.sponsPackageIds})}),r.userDetails&&(a.pmEntityID=r.userDetails.pmEntityID),s.makeAjaxCalls(i.apiUrl+"/AHC/GetPriceForPackage",a,"POST").then(function(e){e.data.isSuccess?(n.groupedPackagePrice=_.groupBy(e.data.packagePriceDetail,"maid"),t(n)):o(e.data)})});return t},D=function(e,a){var r=s.isUserSignedin(),t=new Promise(function(t,o){var n={};if(a&&r){var c={packageId:e,employeeId:r.corpDetails.iwpEmployeeId,maid:r.userDetails.maid};s.makeAjaxCalls(i.apiUrl+"AHC/PackageDetails",c,"POST",r.token,s.getCity()).then(function(e){e.data.packageDetail?(e.data.serverDate&&(s.serverDate=parseInt(e.data.serverDate.replace("/Date(",""))),n.packageDetail=e.data.packageDetail,t(n)):o()})}else s.makeAjaxCalls(i.apiUrl+"PackageDetails/"+e,"","Get","",s.getCity()).then(function(e){e.data.packageDetail?(e.data.serverDate&&(s.serverDate=parseInt(e.data.serverDate.replace("/Date(",""))),n.packageDetail=e.data.packageDetail,n.blockBookingDetails=e.data.blockBookingDetails,t(n)):o()})});return t},y=function(e){var a=s.getCity(),r=[];return _.isEmpty(e)||(l=_.uniq(_.pluck(e,"dcCity")),s.topCities=_.intersection(g,l),s.allCities=_.difference(l,s.topCities),s.cityError=_.contains(l,a)?"":a?"Service is not available in <b>"+a+"</b>, please select a city":"Please select a city",s.cityError?s.cityPopup("lg"):r=_.filter(e,function(e){return e.dcCity==a})),r},I=function(e,a,r){s.corporatePackages.internalPhleboMapping={alternateProvider:r};var t=[];return _.isEmpty(e)||_.isEmpty(s.corporatePackages.providerPincodeLocations)||_.each(e,function(e){s.corporatePackages.providerPincodeLocations.hasOwnProperty(e.dcId)&&_.pluck(s.corporatePackages.providerPincodeLocations[e.dcId],"pincode").includes(+a)&&(t.push(e),s.corporatePackages.internalPhleboMapping.hasOwnProperty("replaceByProvider")||e.dcId==r||(s.corporatePackages.internalPhleboMapping.replaceByProvider=e))}),t},h=function(e){var r=s.isUserSignedin();s.makeAjaxCalls(i.apiUrl+"UpdatePartialProfile/",{PrimaryPhoneNumber:e},"POST",r.token,s.getCity()).then(function(t){t.data.isSuccess&&(r.userDetails&&(r.userDetails.phone=e),a.getFlatProperty(r,"corpDetails.employeeDetail")&&(r.corpDetails.employeeDetail.mobileNumber=e),o.set("_mp_user",r),s.corporatePackages.employeeDetail.mobileNumber=e)})},S=function(e){if(e&&e.dcId&&e.providerRelativeUrl&&e.providerRelativeUrl.indexOf(location.origin)==-1){var a=e.dcId.indexOf("a"),r=e.dcId;a>2&&(r=e.dcId.substr(0,a));var i=t.providerWithProfile;_.contains(i,r)?e.providerRelativeUrl=location.origin+"/providerProfile/"+e.providerRelativeUrl:e.providerRelativeUrl=null}return e};return{getAHCPackage:k,getAHCPhloboProviderUnionSlots:f,getProviderSlots:v,getAhcPackagePrice:m,getPackageDetail:D,filterProvidersByCity:y,filterProvidersByPincode:I,updateUserProfile:h,filterProviderWithProfile:S,addOnBenefs:P,sendCleverTapEvent:function(e,a,r,t){window._MB_Analytics.__push({isCleverTap:!0,isGoogle:!1,name:e,dbLog:"ucp",hj:!0,googleSheet:"UCP Package Selection"==e&&t,payload:window._Site_Props.__getEventParameters({custom:a,service:r})})}}}])})}();